<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>17 Server-side linking with shiny | Interactive web-based data visualization with R, plotly, and shiny</title>
  <meta name="description" content="A useR guide to creating highly interactive graphics for exploratory and expository visualization." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="17 Server-side linking with shiny | Interactive web-based data visualization with R, plotly, and shiny" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A useR guide to creating highly interactive graphics for exploratory and expository visualization." />
  <meta name="github-repo" content="ropensci/plotly" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="17 Server-side linking with shiny | Interactive web-based data visualization with R, plotly, and shiny" />
  <meta name="twitter:site" content="@cpsievert" />
  <meta name="twitter:description" content="A useR guide to creating highly interactive graphics for exploratory and expository visualization." />
  

<meta name="author" content="Carson Sievert" />


<meta name="date" content="2019-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="client-side-linking.html">
<link rel="next" href="javascript.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<script src="libs/plotly-binding/plotly.js"></script>
<script src="libs/typedarray/typedarray.min.js"></script>
<link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main/plotly-latest.min.js"></script>
<link href="libs/selectize/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize/selectize.min.js"></script>
<link href="libs/colourpicker/colourpicker.min.css" rel="stylesheet" />
<script src="libs/colourpicker/colourpicker.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/plotly.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />
<link rel="stylesheet" href="css/summary-fix.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#why-interactive-web-graphics-from-r"><i class="fa fa-check"></i><b>1.1</b> Why interactive web graphics <em>from R</em>?</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-you-will-learn"><i class="fa fa-check"></i><b>1.2</b> What you will learn</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#what-you-wont-learn-much-of"><i class="fa fa-check"></i><b>1.3</b> What you won’t learn (much of)</a><ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#web-technologies"><i class="fa fa-check"></i><b>1.3.1</b> Web technologies</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#d3js"><i class="fa fa-check"></i><b>1.3.2</b> d3js</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#ggplot2"><i class="fa fa-check"></i><b>1.3.3</b> ggplot2</a></li>
<li class="chapter" data-level="1.3.4" data-path="introduction.html"><a href="introduction.html#graphical-data-analysis"><i class="fa fa-check"></i><b>1.3.4</b> Graphical data analysis</a></li>
<li class="chapter" data-level="1.3.5" data-path="introduction.html"><a href="introduction.html#data-visualization-best-practices"><i class="fa fa-check"></i><b>1.3.5</b> Data visualization best practices</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.4</b> Prerequisites</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#run-code-examples"><i class="fa fa-check"></i><b>1.5</b> Run code examples</a></li>
<li class="chapter" data-level="1.6" data-path="introduction.html"><a href="introduction.html#getting-help-and-learning-more"><i class="fa fa-check"></i><b>1.6</b> Getting help and learning more</a></li>
<li class="chapter" data-level="1.7" data-path="introduction.html"><a href="introduction.html#acknowledgements"><i class="fa fa-check"></i><b>1.7</b> Acknowledgements</a></li>
<li class="chapter" data-level="1.8" data-path="introduction.html"><a href="introduction.html#colophon"><i class="fa fa-check"></i><b>1.8</b> Colophon</a></li>
</ul></li>
<li class="part"><span><b>I Creating views</b></span></li>
<li class="chapter" data-level="2" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>2</b> Overview</a><ul>
<li class="chapter" data-level="2.1" data-path="overview.html"><a href="overview.html#intro-plotly"><i class="fa fa-check"></i><b>2.1</b> Intro to <code>plot_ly()</code></a></li>
<li class="chapter" data-level="2.2" data-path="overview.html"><a href="overview.html#intro-plotly-js"><i class="fa fa-check"></i><b>2.2</b> Intro to plotly.js</a></li>
<li class="chapter" data-level="2.3" data-path="overview.html"><a href="overview.html#intro-ggplotly"><i class="fa fa-check"></i><b>2.3</b> Intro to <code>ggplotly()</code></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="scatter-traces.html"><a href="scatter-traces.html"><i class="fa fa-check"></i><b>3</b> Scattered foundations</a><ul>
<li class="chapter" data-level="3.1" data-path="scatter-traces.html"><a href="scatter-traces.html#markers"><i class="fa fa-check"></i><b>3.1</b> Markers</a><ul>
<li class="chapter" data-level="3.1.1" data-path="scatter-traces.html"><a href="scatter-traces.html#marker-alpha"><i class="fa fa-check"></i><b>3.1.1</b> Alpha blending</a></li>
<li class="chapter" data-level="3.1.2" data-path="scatter-traces.html"><a href="scatter-traces.html#marker-color"><i class="fa fa-check"></i><b>3.1.2</b> Colors</a></li>
<li class="chapter" data-level="3.1.3" data-path="scatter-traces.html"><a href="scatter-traces.html#marker-symbol"><i class="fa fa-check"></i><b>3.1.3</b> Symbols</a></li>
<li class="chapter" data-level="3.1.4" data-path="scatter-traces.html"><a href="scatter-traces.html#marker-stroke"><i class="fa fa-check"></i><b>3.1.4</b> Stroke and span</a></li>
<li class="chapter" data-level="3.1.5" data-path="scatter-traces.html"><a href="scatter-traces.html#marker-size"><i class="fa fa-check"></i><b>3.1.5</b> Size</a></li>
<li class="chapter" data-level="3.1.6" data-path="scatter-traces.html"><a href="scatter-traces.html#dot-plots"><i class="fa fa-check"></i><b>3.1.6</b> Dotplots &amp; error bars</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="scatter-traces.html"><a href="scatter-traces.html#lines"><i class="fa fa-check"></i><b>3.2</b> Lines</a><ul>
<li class="chapter" data-level="3.2.1" data-path="scatter-traces.html"><a href="scatter-traces.html#linetypes"><i class="fa fa-check"></i><b>3.2.1</b> Linetypes</a></li>
<li class="chapter" data-level="3.2.2" data-path="scatter-traces.html"><a href="scatter-traces.html#segments"><i class="fa fa-check"></i><b>3.2.2</b> Segments</a></li>
<li class="chapter" data-level="3.2.3" data-path="scatter-traces.html"><a href="scatter-traces.html#density-plots"><i class="fa fa-check"></i><b>3.2.3</b> Density plots</a></li>
<li class="chapter" data-level="3.2.4" data-path="scatter-traces.html"><a href="scatter-traces.html#parallel-coordinates"><i class="fa fa-check"></i><b>3.2.4</b> Parallel Coordinates</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="scatter-traces.html"><a href="scatter-traces.html#polygons"><i class="fa fa-check"></i><b>3.3</b> Polygons</a><ul>
<li class="chapter" data-level="3.3.1" data-path="scatter-traces.html"><a href="scatter-traces.html#ribbons"><i class="fa fa-check"></i><b>3.3.1</b> Ribbons</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>4</b> Maps</a><ul>
<li class="chapter" data-level="4.1" data-path="maps.html"><a href="maps.html#maps-integrated"><i class="fa fa-check"></i><b>4.1</b> Integrated maps</a><ul>
<li class="chapter" data-level="4.1.1" data-path="maps.html"><a href="maps.html#overview-1"><i class="fa fa-check"></i><b>4.1.1</b> Overview</a></li>
<li class="chapter" data-level="4.1.2" data-path="maps.html"><a href="maps.html#choropleths"><i class="fa fa-check"></i><b>4.1.2</b> Choropleths</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="maps.html"><a href="maps.html#maps-custom"><i class="fa fa-check"></i><b>4.2</b> Custom maps</a><ul>
<li class="chapter" data-level="4.2.1" data-path="maps.html"><a href="maps.html#sf"><i class="fa fa-check"></i><b>4.2.1</b> Simple features (sf)</a></li>
<li class="chapter" data-level="4.2.2" data-path="maps.html"><a href="maps.html#cartograms"><i class="fa fa-check"></i><b>4.2.2</b> Cartograms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bars-histograms.html"><a href="bars-histograms.html"><i class="fa fa-check"></i><b>5</b> Bars &amp; histograms</a><ul>
<li class="chapter" data-level="5.1" data-path="bars-histograms.html"><a href="bars-histograms.html#multiple-numeric-distributions"><i class="fa fa-check"></i><b>5.1</b> Multiple numeric distributions</a></li>
<li class="chapter" data-level="5.2" data-path="bars-histograms.html"><a href="bars-histograms.html#multiple-discrete-distributions"><i class="fa fa-check"></i><b>5.2</b> Multiple discrete distributions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="boxplots.html"><a href="boxplots.html"><i class="fa fa-check"></i><b>6</b> Boxplots</a></li>
<li class="chapter" data-level="7" data-path="frequencies-2D.html"><a href="frequencies-2D.html"><i class="fa fa-check"></i><b>7</b> 2D frequencies</a><ul>
<li class="chapter" data-level="7.1" data-path="frequencies-2D.html"><a href="frequencies-2D.html#rectangular-binning-in-plotly.js"><i class="fa fa-check"></i><b>7.1</b> Rectangular binning in plotly.js</a></li>
<li class="chapter" data-level="7.2" data-path="frequencies-2D.html"><a href="frequencies-2D.html#rectangular-binning-in-r"><i class="fa fa-check"></i><b>7.2</b> Rectangular binning in R</a></li>
<li class="chapter" data-level="7.3" data-path="frequencies-2D.html"><a href="frequencies-2D.html#categorical-axes"><i class="fa fa-check"></i><b>7.3</b> Categorical axes</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="d-charts.html"><a href="d-charts.html"><i class="fa fa-check"></i><b>8</b> 3D charts</a><ul>
<li class="chapter" data-level="8.1" data-path="d-charts.html"><a href="d-charts.html#markers-1"><i class="fa fa-check"></i><b>8.1</b> Markers</a></li>
<li class="chapter" data-level="8.2" data-path="d-charts.html"><a href="d-charts.html#paths"><i class="fa fa-check"></i><b>8.2</b> Paths</a></li>
<li class="chapter" data-level="8.3" data-path="d-charts.html"><a href="d-charts.html#lines-1"><i class="fa fa-check"></i><b>8.3</b> Lines</a></li>
<li class="chapter" data-level="8.4" data-path="d-charts.html"><a href="d-charts.html#axes"><i class="fa fa-check"></i><b>8.4</b> Axes</a></li>
<li class="chapter" data-level="8.5" data-path="d-charts.html"><a href="d-charts.html#surfaces"><i class="fa fa-check"></i><b>8.5</b> Surfaces</a></li>
</ul></li>
<li class="part"><span><b>II Publishing views</b></span></li>
<li class="chapter" data-level="9" data-path="publish.html"><a href="publish.html"><i class="fa fa-check"></i><b>9</b> Introduction</a></li>
<li class="chapter" data-level="10" data-path="saving.html"><a href="saving.html"><i class="fa fa-check"></i><b>10</b> Saving and embedding HTML</a></li>
<li class="chapter" data-level="11" data-path="exporting-static-images.html"><a href="exporting-static-images.html"><i class="fa fa-check"></i><b>11</b> Exporting static images</a><ul>
<li class="chapter" data-level="11.1" data-path="exporting-static-images.html"><a href="exporting-static-images.html#with-code"><i class="fa fa-check"></i><b>11.1</b> With code</a></li>
<li class="chapter" data-level="11.2" data-path="exporting-static-images.html"><a href="exporting-static-images.html#from-a-browser"><i class="fa fa-check"></i><b>11.2</b> From a browser</a></li>
<li class="chapter" data-level="11.3" data-path="exporting-static-images.html"><a href="exporting-static-images.html#sizing-exports"><i class="fa fa-check"></i><b>11.3</b> Sizing exports</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="editing-views.html"><a href="editing-views.html"><i class="fa fa-check"></i><b>12</b> Editing views for publishing</a></li>
<li class="part"><span><b>III Combining multiple views</b></span></li>
<li class="chapter" data-level="13" data-path="arranging-views.html"><a href="arranging-views.html"><i class="fa fa-check"></i><b>13</b> Arranging views</a><ul>
<li class="chapter" data-level="13.1" data-path="arranging-views.html"><a href="arranging-views.html#arranging-plotly-objects"><i class="fa fa-check"></i><b>13.1</b> Arranging plotly objects</a><ul>
<li class="chapter" data-level="13.1.1" data-path="arranging-views.html"><a href="arranging-views.html#recursive-subplots"><i class="fa fa-check"></i><b>13.1.1</b> Recursive subplots</a></li>
<li class="chapter" data-level="13.1.2" data-path="arranging-views.html"><a href="arranging-views.html#other-approaches-applications"><i class="fa fa-check"></i><b>13.1.2</b> Other approaches &amp; applications</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="arranging-views.html"><a href="arranging-views.html#arranging-htmlwidgets"><i class="fa fa-check"></i><b>13.2</b> Arranging htmlwidgets</a><ul>
<li class="chapter" data-level="13.2.1" data-path="arranging-views.html"><a href="arranging-views.html#flexdashboard"><i class="fa fa-check"></i><b>13.2.1</b> Flexdashboard</a></li>
<li class="chapter" data-level="13.2.2" data-path="arranging-views.html"><a href="arranging-views.html#bootstrap-grid-layout"><i class="fa fa-check"></i><b>13.2.2</b> Bootstrap grid layout</a></li>
<li class="chapter" data-level="13.2.3" data-path="arranging-views.html"><a href="arranging-views.html#css-flexbox"><i class="fa fa-check"></i><b>13.2.3</b> CSS flexbox</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="arranging-views.html"><a href="arranging-views.html#navigating-many-views"><i class="fa fa-check"></i><b>13.3</b> Arranging many views</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="animating-views.html"><a href="animating-views.html"><i class="fa fa-check"></i><b>14</b> Animating views</a><ul>
<li class="chapter" data-level="14.1" data-path="animating-views.html"><a href="animating-views.html#animation-api"><i class="fa fa-check"></i><b>14.1</b> Animation API</a></li>
<li class="chapter" data-level="14.2" data-path="animating-views.html"><a href="animating-views.html#animation-support"><i class="fa fa-check"></i><b>14.2</b> Animation support</a></li>
</ul></li>
<li class="part"><span><b>IV Linking multiple views</b></span></li>
<li class="chapter" data-level="15" data-path="introduction-1.html"><a href="introduction-1.html"><i class="fa fa-check"></i><b>15</b> Introduction</a></li>
<li class="chapter" data-level="16" data-path="client-side-linking.html"><a href="client-side-linking.html"><i class="fa fa-check"></i><b>16</b> Client-side linking</a><ul>
<li class="chapter" data-level="16.1" data-path="client-side-linking.html"><a href="client-side-linking.html#graphical-queries"><i class="fa fa-check"></i><b>16.1</b> Graphical queries</a></li>
<li class="chapter" data-level="16.2" data-path="client-side-linking.html"><a href="client-side-linking.html#filter"><i class="fa fa-check"></i><b>16.2</b> Highlight versus filter events</a></li>
<li class="chapter" data-level="16.3" data-path="client-side-linking.html"><a href="client-side-linking.html#linking-animated-views"><i class="fa fa-check"></i><b>16.3</b> Linking animated views</a></li>
<li class="chapter" data-level="16.4" data-path="client-side-linking.html"><a href="client-side-linking.html#querying-examples"><i class="fa fa-check"></i><b>16.4</b> Examples</a><ul>
<li class="chapter" data-level="16.4.1" data-path="client-side-linking.html"><a href="client-side-linking.html#trellis-linking"><i class="fa fa-check"></i><b>16.4.1</b> Querying facetted charts</a></li>
<li class="chapter" data-level="16.4.2" data-path="client-side-linking.html"><a href="client-side-linking.html#statistical-queries"><i class="fa fa-check"></i><b>16.4.2</b> Statistical queries</a></li>
<li class="chapter" data-level="16.4.3" data-path="client-side-linking.html"><a href="client-side-linking.html#statistical-queries-ggplot"><i class="fa fa-check"></i><b>16.4.3</b> Statistical queries with <code>ggplotly()</code></a></li>
<li class="chapter" data-level="16.4.4" data-path="client-side-linking.html"><a href="client-side-linking.html#geo-spatial-queries"><i class="fa fa-check"></i><b>16.4.4</b> Geo-spatial queries</a></li>
<li class="chapter" data-level="16.4.5" data-path="client-side-linking.html"><a href="client-side-linking.html#linking-with-other-htmlwidgets"><i class="fa fa-check"></i><b>16.4.5</b> Linking with other htmlwidgets</a></li>
<li class="chapter" data-level="16.4.6" data-path="client-side-linking.html"><a href="client-side-linking.html#ggally-ggpairs"><i class="fa fa-check"></i><b>16.4.6</b> Generalized pairs plots</a></li>
<li class="chapter" data-level="16.4.7" data-path="client-side-linking.html"><a href="client-side-linking.html#ggally-ggnostic"><i class="fa fa-check"></i><b>16.4.7</b> Querying diagnostic plots</a></li>
</ul></li>
<li class="chapter" data-level="16.5" data-path="client-side-linking.html"><a href="client-side-linking.html#limitations"><i class="fa fa-check"></i><b>16.5</b> Limitations</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html"><i class="fa fa-check"></i><b>17</b> Server-side linking with shiny</a><ul>
<li class="chapter" data-level="17.1" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#hello-shiny"><i class="fa fa-check"></i><b>17.1</b> Embedding plotly in shiny</a><ul>
<li class="chapter" data-level="17.1.1" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#your-first-shiny-app"><i class="fa fa-check"></i><b>17.1.1</b> Your first shiny app</a></li>
<li class="chapter" data-level="17.1.2" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#hiding-and-redrawing-on-resize"><i class="fa fa-check"></i><b>17.1.2</b> Hiding and redrawing on resize</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#shiny-plotly-inputs"><i class="fa fa-check"></i><b>17.2</b> Leveraging plotly input events</a><ul>
<li class="chapter" data-level="17.2.1" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#dragging-events"><i class="fa fa-check"></i><b>17.2.1</b> Dragging events</a></li>
<li class="chapter" data-level="17.2.2" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#d-events"><i class="fa fa-check"></i><b>17.2.2</b> 3D events</a></li>
<li class="chapter" data-level="17.2.3" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#edit-events"><i class="fa fa-check"></i><b>17.2.3</b> Edit events</a></li>
<li class="chapter" data-level="17.2.4" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#relayout-vs-restyle-events"><i class="fa fa-check"></i><b>17.2.4</b> Relayout vs restyle events</a></li>
<li class="chapter" data-level="17.2.5" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#scoping-events"><i class="fa fa-check"></i><b>17.2.5</b> Scoping events</a></li>
<li class="chapter" data-level="17.2.6" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#event-priority"><i class="fa fa-check"></i><b>17.2.6</b> Event priority</a></li>
<li class="chapter" data-level="17.2.7" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#handling-discrete-axes"><i class="fa fa-check"></i><b>17.2.7</b> Handling discrete axes</a></li>
<li class="chapter" data-level="17.2.8" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#reactive-vals"><i class="fa fa-check"></i><b>17.2.8</b> Accumulating and managing event data</a></li>
</ul></li>
<li class="chapter" data-level="17.3" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#shiny-performance"><i class="fa fa-check"></i><b>17.3</b> Improving performance</a><ul>
<li class="chapter" data-level="17.3.1" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#proxies"><i class="fa fa-check"></i><b>17.3.1</b> Partial plotly updates</a></li>
<li class="chapter" data-level="17.3.2" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#partial-update-examples"><i class="fa fa-check"></i><b>17.3.2</b> Partial update examples</a></li>
</ul></li>
<li class="chapter" data-level="17.4" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#advanced-applications"><i class="fa fa-check"></i><b>17.4</b> Advanced applications</a><ul>
<li class="chapter" data-level="17.4.1" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#drill-down"><i class="fa fa-check"></i><b>17.4.1</b> Drill-down</a></li>
<li class="chapter" data-level="17.4.2" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#crossfilter"><i class="fa fa-check"></i><b>17.4.2</b> Cross-filter</a></li>
<li class="chapter" data-level="17.4.3" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#drag-brush"><i class="fa fa-check"></i><b>17.4.3</b> A draggable brush</a></li>
</ul></li>
<li class="chapter" data-level="17.5" data-path="linking-views-with-shiny.html"><a href="linking-views-with-shiny.html#discussion"><i class="fa fa-check"></i><b>17.5</b> Discussion</a></li>
</ul></li>
<li class="part"><span><b>V Event handling in JavaScript</b></span></li>
<li class="chapter" data-level="18" data-path="javascript.html"><a href="javascript.html"><i class="fa fa-check"></i><b>18</b> Introduction</a></li>
<li class="chapter" data-level="19" data-path="json.html"><a href="json.html"><i class="fa fa-check"></i><b>19</b> Working with JSON</a><ul>
<li class="chapter" data-level="19.1" data-path="json.html"><a href="json.html#assignment-subsetting-and-iteration"><i class="fa fa-check"></i><b>19.1</b> Assignment, subsetting, and iteration</a></li>
<li class="chapter" data-level="19.2" data-path="json.html"><a href="json.html#mapping-r-to-json"><i class="fa fa-check"></i><b>19.2</b> Mapping R to JSON</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="js-event-handlers.html"><a href="js-event-handlers.html"><i class="fa fa-check"></i><b>20</b> Adding custom event handlers</a></li>
<li class="chapter" data-level="21" data-path="supplying-custom-data.html"><a href="supplying-custom-data.html"><i class="fa fa-check"></i><b>21</b> Supplying custom data</a></li>
<li class="chapter" data-level="22" data-path="client-side.html"><a href="client-side.html"><i class="fa fa-check"></i><b>22</b> Leveraging web technologies from R</a><ul>
<li class="chapter" data-level="22.1" data-path="client-side.html"><a href="client-side.html#web-infrastructure"><i class="fa fa-check"></i><b>22.1</b> Web infrastructure</a></li>
<li class="chapter" data-level="22.2" data-path="client-side.html"><a href="client-side.html#react"><i class="fa fa-check"></i><b>22.2</b> Modern JS &amp; React</a></li>
</ul></li>
<li class="part"><span><b>VI Various special topics</b></span></li>
<li class="chapter" data-level="23" data-path="is-plotly-free-secure.html"><a href="is-plotly-free-secure.html"><i class="fa fa-check"></i><b>23</b> Is plotly free &amp; secure?</a></li>
<li class="chapter" data-level="24" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>24</b> Improving performance</a></li>
<li class="chapter" data-level="25" data-path="controlling-tooltips.html"><a href="controlling-tooltips.html"><i class="fa fa-check"></i><b>25</b> Controlling tooltips</a><ul>
<li class="chapter" data-level="25.1" data-path="controlling-tooltips.html"><a href="controlling-tooltips.html#tooltip-text"><i class="fa fa-check"></i><b>25.1</b> <code>plot_ly()</code> tooltips</a></li>
<li class="chapter" data-level="25.2" data-path="controlling-tooltips.html"><a href="controlling-tooltips.html#tooltip-text-ggplotly"><i class="fa fa-check"></i><b>25.2</b> <code>ggplotly()</code> tooltips</a></li>
<li class="chapter" data-level="25.3" data-path="controlling-tooltips.html"><a href="controlling-tooltips.html#styling"><i class="fa fa-check"></i><b>25.3</b> Styling</a></li>
</ul></li>
<li class="chapter" data-level="26" data-path="control-modebar.html"><a href="control-modebar.html"><i class="fa fa-check"></i><b>26</b> Control the modebar</a><ul>
<li class="chapter" data-level="26.1" data-path="control-modebar.html"><a href="control-modebar.html#remove-the-entire-modebar"><i class="fa fa-check"></i><b>26.1</b> Remove the entire modebar</a></li>
<li class="chapter" data-level="26.2" data-path="control-modebar.html"><a href="control-modebar.html#remove-the-plotly-logo"><i class="fa fa-check"></i><b>26.2</b> Remove the plotly logo</a></li>
<li class="chapter" data-level="26.3" data-path="control-modebar.html"><a href="control-modebar.html#remove-modebar-buttons-by-name"><i class="fa fa-check"></i><b>26.3</b> Remove modebar buttons by name</a></li>
<li class="chapter" data-level="26.4" data-path="control-modebar.html"><a href="control-modebar.html#add-custom-modebar-buttons"><i class="fa fa-check"></i><b>26.4</b> Add custom modebar buttons</a></li>
<li class="chapter" data-level="26.5" data-path="control-modebar.html"><a href="control-modebar.html#control-image-downloads"><i class="fa fa-check"></i><b>26.5</b> Control image downloads</a></li>
</ul></li>
<li class="chapter" data-level="27" data-path="working-with-colors.html"><a href="working-with-colors.html"><i class="fa fa-check"></i><b>27</b> Working with colors</a></li>
<li class="chapter" data-level="28" data-path="working-with-symbols.html"><a href="working-with-symbols.html"><i class="fa fa-check"></i><b>28</b> Working with symbols and glyphs</a></li>
<li class="chapter" data-level="29" data-path="embedding-images.html"><a href="embedding-images.html"><i class="fa fa-check"></i><b>29</b> Embedding images</a></li>
<li class="chapter" data-level="30" data-path="locales.html"><a href="locales.html"><i class="fa fa-check"></i><b>30</b> Language support</a></li>
<li class="chapter" data-level="31" data-path="mathjax.html"><a href="mathjax.html"><i class="fa fa-check"></i><b>31</b> LaTeX rendering</a><ul>
<li class="chapter" data-level="31.1" data-path="mathjax.html"><a href="mathjax.html#mathjax-caveats"><i class="fa fa-check"></i><b>31.1</b> MathJax caveats</a></li>
</ul></li>
<li class="chapter" data-level="32" data-path="the-data-plot-pipeline.html"><a href="the-data-plot-pipeline.html"><i class="fa fa-check"></i><b>32</b> The data-plot-pipeline</a></li>
<li class="chapter" data-level="33" data-path="improving-ggplotly.html"><a href="improving-ggplotly.html"><i class="fa fa-check"></i><b>33</b> Improving <code>ggplotly()</code></a><ul>
<li class="chapter" data-level="33.1" data-path="improving-ggplotly.html"><a href="improving-ggplotly.html#modifying-layout"><i class="fa fa-check"></i><b>33.1</b> Modifying layout</a></li>
<li class="chapter" data-level="33.2" data-path="improving-ggplotly.html"><a href="improving-ggplotly.html#modifying-data"><i class="fa fa-check"></i><b>33.2</b> Modifying data</a></li>
<li class="chapter" data-level="33.3" data-path="improving-ggplotly.html"><a href="improving-ggplotly.html#leveraging-statistical-output"><i class="fa fa-check"></i><b>33.3</b> Leveraging statistical output</a></li>
</ul></li>
<li class="chapter" data-level="34" data-path="custom-geoms.html"><a href="custom-geoms.html"><i class="fa fa-check"></i><b>34</b> Translating custom ggplot2 geoms</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Interactive web-based data visualization with R, plotly, and shiny</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="linking-views-with-shiny" class="section level1">
<h1><span class="header-section-number">17</span> Server-side linking with shiny</h1>
<p>Section <a href="client-side-linking.html#graphical-queries">16.1</a> covers an approach to linking views client-side with graphical database queries, but not every linked data view can be reasonably framed as a database query. If you need more control, you have at least two more options: add custom JavaScript (covered in Section <a href="javascript.html#javascript">18</a>) and/or link views server-side via a web application. Some concepts useful for the former approach are covered in <a href="javascript.html#javascript">18</a>, but this chapter is all about the latter approach.</p>
<p>There are several different frameworks for creating web applications via R, but we’ll focus our attention on linking <strong>plotly</strong> graphs with <strong>shiny</strong> – an R package for creating reactive web applications entirely in R. <strong>Shiny</strong>’s reactive programming model allows R programmers to build upon their existing R knowledge and create data-driven web applications without any prior web programming experience. <strong>Shiny</strong> itself is largely agnostic to the engine used to render data views (that is, you can incorporate any sort of R output), but <strong>shiny</strong> itself also adds some special support for interacting with static R graphics and images <span class="citation">(Chang <a href="#ref-shiny-plot-interaction" role="doc-biblioref">2017</a>)</span>.</p>
<p>When linking graphics in a web application, there are tradeoffs to consider when using static R plots over web-based graphics. As it turns out, those tradeoffs complement nicely with the relative strengths and weaknesses of linking views with <strong>plotly</strong>, making their combination a powerful toolkit for linking views on the web from R. <strong>Shiny</strong> itself provides a way to access events with static graphics made with any of the following R packages: <strong>graphics</strong>, <strong>ggplot2</strong>, and <strong>lattice</strong>. These packages are very mature, fully-featured, well-tested, and support a incredibly wide range of graphics, but since they must be regenerated on the server, they are fundamentally limited from an interactive graphics perspective. Comparatively speaking, <strong>plotly</strong> does not have the same range and history, but it does provide more options and control over interactivity. More specifically, because <strong>plotly</strong> is inherently web-based, it allows for more control over how the graphics update in response to user input (e.g., change the color of a few points instead of redrawing the entire image). This idea is explored in more depth in Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a>.</p>
<p>This chapter teaches you how to use <strong>plotly</strong> graphs inside <strong>shiny</strong>, how to get those graphics communicating with other types of data views, and how to do it all efficiently. Section <a href="linking-views-with-shiny.html#hello-shiny">17.1</a> provides an introduction to <strong>shiny</strong> it’s reactive programming model, Section <a href="linking-views-with-shiny.html#shiny-plotly-inputs">17.2</a> shows how to leverage <strong>plotly</strong> inputs in <strong>shiny</strong> to coordinate multiple views, Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a> shows how to respond to input changes efficiently, and Section <a href="linking-views-with-shiny.html#advanced-applications">17.4</a> demonstrates some advanced applications.</p>
<div id="hello-shiny" class="section level2">
<h2><span class="header-section-number">17.1</span> Embedding plotly in shiny</h2>
<p>Before linking views with <strong>plotly</strong> inside <strong>shiny</strong>, let’s first talk about how to embed <strong>plotly</strong> inside a basic <strong>shiny</strong> app! Through a couple basic examples, you’ll learn the basic components of a <strong>shiny</strong> and get a feel for <strong>shiny</strong>’s reactive programming model, as well as pointers to more learning materials.</p>
<div id="your-first-shiny-app" class="section level3">
<h3><span class="header-section-number">17.1.1</span> Your first shiny app</h3>
<p>The most common <strong>plotly</strong>+<strong>shiny</strong> pattern uses a <strong>shiny</strong> input to control a <strong>plotly</strong> output. Figure <a href="linking-views-with-shiny.html#fig:shiny-intro">17.1</a> gives a simple example of using <strong>shiny</strong>’s <code>selectizeInput()</code> function to create a dropdown that controls a <strong>plotly</strong> graph. This example, as well as every other <strong>shiny</strong> app, has two main parts:</p>
<ol style="list-style-type: decimal">
<li>The <em>user interface</em>, <code>ui</code>, defines how inputs and output widgets are displayed on the page. The <code>fluidPage()</code> function offers a nice and quick way get a grid-based responsive layout<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>, but it’s also worth noting the UI is completely customizable<a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a>, and packages such as <strong>shinydashboard</strong> make it easy to leverage more sophisticated layout frameworks <span class="citation">(Chang and Borges Ribeiro <a href="#ref-shinydashboard" role="doc-biblioref">2018</a>)</span>.</li>
<li>The <em>server</em> function, <code>server</code>, defines a mapping from input values to output widgets. More specifically, the <strong>shiny</strong> <code>server</code> is an R <code>function()</code> between <code>input</code> values on the client and <code>output</code>s generated on the web server.</li>
</ol>
<p>Every input widget, including the <code>selectizeInput()</code> in Figure <a href="linking-views-with-shiny.html#fig:shiny-intro">17.1</a>, is tied to a input value that can be accesssed on the server inside a reactive expression. <strong>Shiny</strong>’s reactive expressions build a dependency graph between outputs (aka, reactive endpoints) and inputs (aka, reactive sources). The true power of reactive expressions lies in their ability to chain together and cache computations, but let’s first focus on generating outputs. In order to generate an output, you have to choose a suitable function for rendering the result of a reactive expression.</p>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-intro">17.1</a> uses the <code>renderPlotly()</code> function to render a reactive expression that generates a <strong>plotly</strong> graph. This expression depends in the input value <code>input$cities</code> (i.e., the input value tied to the input widget with an <code>inputId</code> of <code>"cities"</code>) and stores the output as <code>output$p</code>. This instructs <strong>shiny</strong> to insert the reactive graph into the <code>plotlyOutput(outputId = "p")</code> container defined in the user interface.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">selectizeInput</span>(
    <span class="dt">inputId =</span> <span class="st">&quot;cities&quot;</span>, 
    <span class="dt">label =</span> <span class="st">&quot;Select a city&quot;</span>, 
    <span class="dt">choices =</span> <span class="kw">unique</span>(txhousing<span class="op">$</span>city), 
    <span class="dt">selected =</span> <span class="st">&quot;Abilene&quot;</span>,
    <span class="dt">multiple =</span> <span class="ot">TRUE</span>
  ),
  <span class="kw">plotlyOutput</span>(<span class="dt">outputId =</span> <span class="st">&quot;p&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, ...) {
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(txhousing, <span class="dt">x =</span> <span class="op">~</span>date, <span class="dt">y =</span> <span class="op">~</span>median) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(city <span class="op">%in%</span><span class="st"> </span>input<span class="op">$</span>cities) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">group_by</span>(city) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_lines</span>()
  })
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-intro"></span>
<iframe src="https://player.vimeo.com/video/307597444?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.1: Using a <strong>shiny</strong> input widget to control which time series are shown on a <strong>plotly</strong> graph. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-intro.html" class="uri">https://plotly-r.com/interactives/shiny-intro.html</a>
</p>
</div>
<p>If, instead of a <strong>plotly</strong> graph, a reactive expression generates a static R graphic, simply use <code>renderPlot()</code> (instead of <code>renderPlotly()</code>) to render it and <code>plotOutput()</code> (instead of <code>plotlyOutput()</code>) to position it. Other <strong>shiny</strong> output widgets also use this naming convention: <code>renderDataTable()</code>/<code>datatableOutput()</code>, <code>renderPrint()</code>/<code>verbatimTextOutput()</code>, <code>renderText()</code>/<code>textOutput()</code>, <code>renderImage()</code>/<code>imageOutput()</code>, etc. Packages that are built on the <strong>htmlwidgets</strong> standard (e.g. <strong>plotly</strong> and <strong>leaflet</strong>) are, in some sense, also <strong>shiny</strong> output widgets that are encouraged to follow this same naming convention (e.g. <code>renderPlotly()</code>/<code>plotlyOutput()</code> and <code>renderLeaflet()</code>/<code>leafletOutput()</code>).</p>
<p><strong>Shiny</strong> also comes pre-packaged with a handful of other useful input widgets. Although many <strong>shiny</strong> apps use them straight “out-of-the-box”, input widgets can easily be stylized with CSS and/or SASS, and even custom input widgets can be integrated <span class="citation">(Mastny <a href="#ref-sass" role="doc-biblioref">2018</a>; RStudio <a href="#ref-shiny-custom-inputs" role="doc-biblioref">2014</a><a href="#ref-shiny-custom-inputs" role="doc-biblioref">a</a>)</span>.</p>
<ul>
<li><code>selectInput()</code>/<code>selectizeInput()</code> for dropdown menus.</li>
<li><code>numericInput()</code> for a single number.</li>
<li><code>sliderInput()</code> for a numeric range.</li>
<li><code>textInput()</code> for a character string.</li>
<li><code>dateInput()</code> for a single date.</li>
<li><code>dateRangeInput()</code> for a range of dates.</li>
<li><code>fileInput()</code> for uploading files.</li>
<li><code>checkboxInput()</code>/<code>checkboxGroupInput()</code>/<code>radioButtons()</code> for choosing a list of options.</li>
</ul>
<p>Going forward our focus is to link multiple graphs in <strong>shiny</strong> through direct manipulation, so we focus less on using these input widgets, and more on using <strong>plotly</strong> and static R graphics as inputs to other output widgets. Section <a href="linking-views-with-shiny.html#shiny-plotly-inputs">17.2</a> provides an introduction to this idea, but before we learn how to access these input events, you may want to know a bit more about rendering <strong>plotly</strong> inside <strong>shiny</strong>.</p>
</div>
<div id="hiding-and-redrawing-on-resize" class="section level3">
<h3><span class="header-section-number">17.1.2</span> Hiding and redrawing on resize</h3>
<p>The <code>renderPlotly()</code> function renders anything that the <code>plotly_build()</code> function understands, including <code>plot_ly()</code>, <code>ggplotly()</code>, and <strong>ggplot2</strong> objects.<a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a> It also renders <code>NULL</code> as an empty HTML div, which is handy for certain cases where it doesn’t make sense to render a graph. Figure <a href="linking-views-with-shiny.html#fig:shiny-ggplotly">17.2</a> leverages these features to render an empty div while <code>selectizeInput()</code>’s placeholder is shown, but then render a <strong>plotly</strong> graph via <code>ggplotly()</code> once cities have been selected. Figure <a href="linking-views-with-shiny.html#fig:shiny-ggplotly">17.2</a> also shows how to make the <strong>plotly</strong> output depend on the size of the container that holds the <strong>plotly</strong> graph. By default, when a browser is resized, the graph size is changed purely client-side, but this reactive expression will re-execute when the browser window is resized. Due to technical reasons this can improve <code>ggplotly()</code> resizing behavior<a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a>, but should be used with caution when handling large data and long render times.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

cities &lt;-<span class="st"> </span><span class="kw">unique</span>(txhousing<span class="op">$</span>city)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">selectizeInput</span>(
    <span class="dt">inputId =</span> <span class="st">&quot;cities&quot;</span>, 
    <span class="dt">label =</span> <span class="ot">NULL</span>,
    <span class="co"># placeholder prompt is triggered when first choice is an empty string</span>
    <span class="dt">choices =</span> <span class="kw">c</span>(<span class="st">&quot;Please choose a city&quot;</span> =<span class="st"> &quot;&quot;</span>, cities), 
    <span class="dt">multiple =</span> <span class="ot">TRUE</span>
  ),
  <span class="kw">plotlyOutput</span>(<span class="dt">outputId =</span> <span class="st">&quot;p&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session, ...) {
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">req</span>(input<span class="op">$</span>cities)
    <span class="cf">if</span> (<span class="kw">identical</span>(input<span class="op">$</span>cities, <span class="st">&quot;&quot;</span>)) <span class="kw">return</span>(<span class="ot">NULL</span>)
    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">filter</span>(txhousing, city <span class="op">%in%</span><span class="st"> </span>input<span class="op">$</span>cities)) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, median, <span class="dt">group =</span> city))
    height &lt;-<span class="st"> </span>session<span class="op">$</span>clientData<span class="op">$</span>output_p_height
    width &lt;-<span class="st"> </span>session<span class="op">$</span>clientData<span class="op">$</span>output_p_width
    <span class="kw">ggplotly</span>(p, <span class="dt">height =</span> height, <span class="dt">width =</span> width)
  })
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-ggplotly"></span>
<iframe src="https://player.vimeo.com/video/307598318?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.2: Rendering a <strong>plotly</strong> graph in <strong>shiny</strong> if and only if the <code>selectizeInput()</code>’s dropdown is non-empty. When the graph is present, and the window is resized, then the reactive expression is re-evaluated. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-ggplotly.html" class="uri">https://plotly-r.com/interactives/shiny-ggplotly.html</a>
</p>
</div>
<p>When a reactive expression inside <code>renderPlotly()</code> is re-executes, it triggers a full redraw of the <strong>plotly</strong> graph on the client. Generally speaking, this makes your <strong>shiny</strong> app logic easy to reason about, but it’s not always performant enough. For example, say you have a scatterplot with 10s of thousands of points, and you just want to add a fitted line to those points (in respond to input event)? Instead of redrawing the whole plot from scratch, it can be way more performant to partially update specific components of the visual. Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a> covers this idea through a handful of examples.</p>
<!--
The `renderPlotly()` function anticipates a reactive expression that generates a **plotly** object. **Shiny** itself provides a handful of similar functions that anticipate more "standard" R outputs, like data frames (`renderTable()` or `renderDataTable()`), output from the R graphics device (`renderPlot()`), and things printed to the R console (`renderPrint()` or `renderText()`). Other R packages sometimes provide a custom reactive for a custom R object, and in fact, the **htmlwidgets** package provides a standard way to scaffold this reactive glue which **plotly** implements with `renderPlotly()` and **leaflet** implements with `renderLeaflet()`.

Once a reactive expression generates a value, it needs to know where on the user interface to place the output result. That is why the result of `renderPlotly()` in Figure \@ref(fig:shiny-intro) is assigned to `output$p`. This information lets **shiny** know to insert the code result into `plotlyOutput("p")`, the UI output with an id of "p". At face value, it may seem like **shiny**'s reactive expressions can only produce output widgets, but `renderUI()` allows one to dynamically render input widgets on the server as well.
-->
</div>
</div>
<div id="shiny-plotly-inputs" class="section level2">
<h2><span class="header-section-number">17.2</span> Leveraging plotly input events</h2>
<p>Section <a href="linking-views-with-shiny.html#fig:shiny-intro">17.1</a> covered how to render <strong>shiny</strong> output widgets (e.g., <code>plotlyOutput()</code>) that depend on a input widget, but what about having an output act like an input to another output? For example, say we’d like to dynamically generate a bar chart (i.e., an output) based on a point clicked on a scatter-plot (i.e., an input event tied to an output widget). In addition to <strong>shiny</strong>’s static graph and image rendering functions (e.g., <code>plotOutput()</code>/<code>imageOutput()</code>), there are a handful of other R packages that expose user interaction with “output” widget(s) as input value(s). <span class="citation">Cheng (<a href="#ref-leaflet-shiny" role="doc-biblioref">2018</a><a href="#ref-leaflet-shiny" role="doc-biblioref">c</a>)</span> and <span class="citation">Xie (<a href="#ref-DT-shiny" role="doc-biblioref">2018</a>)</span> describe the interface for the <strong>leaflet</strong> and <strong>DT</strong> packages. This section outlines the interface for <code>plotlyOutput()</code>. This sort of functionality plays a vital role in linking of views through direct manipulation, similar to what we’ve already seen in Section <a href="client-side-linking.html#graphical-queries">16.1</a>, but having access to <strong>plotly</strong> events on a <strong>shiny</strong> server allows for much more flexibility than linking views purely client-side.</p>
<p>The <code>event_data()</code> function is the most straight-forward way to access a <strong>plotly</strong> input events in <strong>shiny</strong>. Although <code>event_data()</code> is function, it references and returns a <strong>shiny</strong> input value, so <code>event_data()</code> needs to be used inside a reactive context. Most of these available events are data-specific traces (e.g., <code>"plotly_hover"</code>, <code>"plotly_click"</code>, <code>"plotly_selected"</code>, etc), but there are also some that are layout-specific (e.g., <code>"plotly_relayout"</code>). Most plotly.js events<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a> are accessible through this interface – for a complete list see the <code>help(event_data)</code> documentation page.</p>
<p>Numerous Figures in the following sections show how to access common <strong>plotly</strong> events in <strong>shiny</strong> and do something with the result. When using these events to inform another view of the data, it’s often necessary to know what portion of data was queried in the event (i.e., the <code>x</code>/<code>y</code> positions alone may not be enough to uniquely identify the information of interest). For this reason, it’s often a good idea to supply a <code>key</code> (and/or <code>customdata</code>) attribute, so that you can map the event data back to the original data. The <code>key</code> attribute is only supported in <strong>shiny</strong>, but <code>customdata</code> is officially supported by plotly.js, and thus can also be used to attach meta-information to event – see Section <a href="javascript.html#javascript">18</a> for more details.</p>
<div id="dragging-events" class="section level3">
<h3><span class="header-section-number">17.2.1</span> Dragging events</h3>
<p>There are currently four different modes for mouse click+drag behavior (i.e., <code>dragmode</code>) in plotly.js: zoom, pan, rectangular selection, and lasso selection. This mode may be changed interactively via the modebar that appears above a <strong>plotly</strong> graph, but the default mode can also be set from the command-line. The default <code>dragmode</code> in Figure <a href="linking-views-with-shiny.html#fig:plotlyEvents">17.3</a> is set to <code>'select'</code>, so that dragging draws a rectangular box which highlights markers. When in this mode, or in the lasso selection mode, information about the drag event can be accessed in four different ways: <code>"plotly_selecting"</code>, <code>"plotly_selected"</code>, <code>"plotly_brushing"</code>, and <code>"plotly_brushed"</code>. Both the <code>"plotly_selecting"</code> and <code>"plotly_selected"</code> events emit information about trace(s) appearing within the interior of the brush – the only difference is that <code>"plotly_selecting"</code> fires repeatedly <em>during</em> drag events, whereas <code>"plotly_selected"</code> fires <em>after</em> drag events (i.e., after the mouse has been released). The semantics behind <code>"plotly_brushing"</code> and <code>"plotly_brushed"</code> are similar, but these emit the x/y limits of the selection brush. As for the other two dragging modes (zoom and pan), since they modify the range of the x/y axes, information about these events can be accessed through <code>"plotly_relayout"</code>. Sections <a href="linking-views-with-shiny.html#proxies">17.3.1</a> and <a href="linking-views-with-shiny.html#advanced-applications">17.4</a> both have advanced applications of these dragging events.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;event_data&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:plotlyEvents"></span>
<iframe src="https://player.vimeo.com/video/327625843?title=0&amp;byline=0&amp;portrait=0" width="100%" height="500" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.3: Accessing event data from click and drag events. For the interactive, see <a href="https://plotly-r.com/interactives/plotlyEvents.html" class="uri">https://plotly-r.com/interactives/plotlyEvents.html</a>
</p>
</div>
</div>
<div id="d-events" class="section level3">
<h3><span class="header-section-number">17.2.2</span> 3D events</h3>
<p>Drag selection events (i.e., <code>"plotly_selecting"</code>) are currently only available for 2D charts, but other common events are generally supported for any type of graph, including 3D charts. Figure <a href="linking-views-with-shiny.html#fig:3Devents">17.4</a> accesses various events in 3D including: <code>"plotly_hover"</code>, <code>"plotly_click"</code>, <code>"plotly_legendclick"</code>, <code>"plotly_legenddoubleclick"</code>, and <code>"plotly_relayout"</code>. The data emitted via <code>"plotly_hover"</code> and <code>"plotly_click"</code> is structured similarly to data emitted from <code>"plotly_selecting"</code>/<code>"plotly_selected"</code>. Figure <a href="linking-views-with-shiny.html#fig:3Devents">17.4</a> also demonstrates how one can react to particular components of a conflated event like <code>"plotly_relayout"</code>. That is, <code>"plotly_relayout"</code> will fire whenever <em>any</em> part of the layout has changed, so if we want to trigger behavior if and only if there are changes to the camera eye, one could first check if the information emitted contains information about the camera eye.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;event_data_3D&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:3Devents"></span>
<iframe src="https://player.vimeo.com/video/327600560?title=0&amp;byline=0&amp;portrait=0" width="100%" height="500" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.4: Accessing 3D events. For the interactive, see <a href="https://plotly-r.com/interactives/3Devents.html" class="uri">https://plotly-r.com/interactives/3Devents.html</a>
</p>
</div>
</div>
<div id="edit-events" class="section level3">
<h3><span class="header-section-number">17.2.3</span> Edit events</h3>
<p>A little known fact about <strong>plotly</strong> is that you can directly manipulate annotations, title, shapes (e.g., circle, lines, rectangles), legends, and more by simply adding <code>config(p, editable = TRUE)</code> to a plot <code>p</code>. Moreover, since these are all layout components, we can access and respond to these ‘edit events’ by listening to the <code>"plotly_relayout"</code> events. Figure <a href="linking-views-with-shiny.html#fig:shiny-edit-annotations">17.5</a> demonstrates how display access information about changes in annotation positioning and content.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;p&quot;</span>),
  <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;info&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(
        <span class="dt">annotations =</span> <span class="kw">list</span>(
          <span class="kw">list</span>(
            <span class="dt">text =</span> emo<span class="op">::</span><span class="kw">ji</span>(<span class="st">&quot;fire&quot;</span>),
            <span class="dt">x =</span> <span class="fl">0.5</span>, 
            <span class="dt">y =</span> <span class="fl">0.5</span>, 
            <span class="dt">xref =</span> <span class="st">&quot;paper&quot;</span>,
            <span class="dt">yref =</span> <span class="st">&quot;paper&quot;</span>,
            <span class="dt">showarrow =</span> <span class="ot">FALSE</span>
          ),
          <span class="kw">list</span>(
            <span class="dt">text =</span> <span class="st">&quot;fire&quot;</span>,
            <span class="dt">x =</span> <span class="fl">0.5</span>, 
            <span class="dt">y =</span> <span class="fl">0.5</span>, 
            <span class="dt">xref =</span> <span class="st">&quot;paper&quot;</span>,
            <span class="dt">yref =</span> <span class="st">&quot;paper&quot;</span>
          )
        )) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">config</span>(<span class="dt">editable =</span> <span class="ot">TRUE</span>)
  })
  
  output<span class="op">$</span>info &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({
    <span class="kw">event_data</span>(<span class="st">&quot;plotly_relayout&quot;</span>)
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-edit-annotations"></span>
<iframe src="https://player.vimeo.com/video/307597631?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.5: Accessing information about direct manipulation of annotations. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-edit-annotations.html" class="uri">https://plotly-r.com/interactives/shiny-edit-annotations.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-drag-circle">17.6</a> demonstrates directly manipulating a circle shape and accessing the new positions of the circle. In constrast to Figure <a href="linking-views-with-shiny.html#fig:shiny-edit-annotations">17.5</a>, which made everything (e.g. the plot and axis titles) editable via <code>config(p, editable = TRUE)</code>, note how Figure <a href="linking-views-with-shiny.html#fig:shiny-drag-circle">17.6</a> makes use of the <code>edits</code> argument to make only the shapes editable.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;p&quot;</span>),
  <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;event&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(
        <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)),
        <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>)),
        <span class="dt">shapes =</span> <span class="kw">list</span>(
          <span class="dt">type =</span> <span class="st">&quot;circle&quot;</span>, 
          <span class="dt">fillcolor =</span> <span class="st">&quot;gray&quot;</span>,
          <span class="dt">line =</span> <span class="kw">list</span>(<span class="dt">color =</span> <span class="st">&quot;gray&quot;</span>),
          <span class="dt">x0 =</span> <span class="dv">-10</span>, <span class="dt">x1 =</span> <span class="dv">10</span>,
          <span class="dt">y0 =</span> <span class="dv">-10</span>, <span class="dt">y1 =</span> <span class="dv">10</span>,
          <span class="dt">xsizemode =</span> <span class="st">&quot;pixel&quot;</span>, 
          <span class="dt">ysizemode =</span> <span class="st">&quot;pixel&quot;</span>,
          <span class="dt">xanchor =</span> <span class="dv">0</span>, <span class="dt">yanchor =</span> <span class="dv">0</span>
        )
      ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">config</span>(<span class="dt">edits =</span> <span class="kw">list</span>(<span class="dt">shapePosition =</span> <span class="ot">TRUE</span>))
  })
  
  output<span class="op">$</span>event &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({
    <span class="kw">event_data</span>(<span class="st">&quot;plotly_relayout&quot;</span>)
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-drag-circle"></span>
<iframe src="https://player.vimeo.com/video/327619858?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.6: Accessing information about direct manipulation of circle shapes. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drag-circle.html" class="uri">https://plotly-r.com/interactives/shiny-drag-circle.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:interactive-lm">17.7</a> demonstrates a linear model that reacts to edited circle shape positions using the <code>"plotly_relayout"</code> event in <strong>shiny</strong>. This interactive tool is an effective way to visualize the impact of high leverage points on a linear model fit. The main idea is to have the model fit (as well as it’s summary and predicted values) depend on the current state of x and y values, which here is stored and updated via <code>reactiveValues()</code>. Section <a href="linking-views-with-shiny.html#reactive-vals">17.2.8</a> has more examples of using reactive values to maintain state within a <strong>shiny</strong> application.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;drag_markers&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:interactive-lm"></span>
<iframe src="https://player.vimeo.com/video/318338029?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.7: Editing circle shape positions to dynamically alter a linear model summary and fitted line. This is useful mainly as a teaching device to visually demonstrate the effect of high leverage points on a simple linear model. For the interactive, see <a href="https://plotly-r.com/interactives/interactive-lm.html" class="uri">https://plotly-r.com/interactives/interactive-lm.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-drag-line">17.8</a> uses an editable vertical line and the <code>plotly_relayout</code> event data to ‘snap’ the line to the closest point in a sequence of <code>x</code> values. It also places a marker on the intersection between the vertical line shape and the line chart of <code>y</code> values. Notice how, by accessing <code>event_data()</code> in this way (i.e., the source and target view of the event is the same), the chart is actually fully redrawn every time the line shape moves. If performance were an issue (i.e., we were dealing with lots of lines), this type of interaction likely won’t be very responsive. In that case, you can use <code>event_data()</code> to trigger side-effects (i.e., partially modify the plot) which is covered in <a href="linking-views-with-shiny.html#proxies">17.3.1</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;drag_lines&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-drag-line"></span>
<iframe src="https://player.vimeo.com/video/307597984?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.8: Dragging a vertical line shape and ‘snapping’ the line to match the closest provided <code>x</code> value. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drag-line.html" class="uri">https://plotly-r.com/interactives/shiny-drag-line.html</a>
</p>
</div>
</div>
<div id="relayout-vs-restyle-events" class="section level3">
<h3><span class="header-section-number">17.2.4</span> Relayout vs restyle events</h3>
<p>Remember every <strong>graph</strong> has two critical components: data (i.e., traces) and layout. Similar to how <code>"plotly_relayout"</code> reports partial modifications to the layout, the <code>"plotly_restyle"</code> event reports partial modification to traces. Compared to <code>"plotly_relayout"</code>, there aren’t very many native direct manipulation events that would trigger a <code>"plotly_restyle"</code> event. For example, zoom/pan events, camera changes, editing annotations/shapes/etc all trigger a <code>"plotly_relayout"</code> event, but not many traces allow you to directly manipulate their properties. One notable exception is the <code>"parcoords"</code> trace type which has native support for brushing lines along an axis dimension(s). As Figure <a href="linking-views-with-shiny.html#fig:shiny-parcoords">17.9</a> demonstrates, these brush events emit a <code>"plotly_restyle"</code> event with the range(s) of the highlighted dimension.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;parcoords&quot;</span>),
  <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;info&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  d &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select_if</span>(iris, is.numeric)
  
  output<span class="op">$</span>parcoords &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    
    dims &lt;-<span class="st"> </span><span class="kw">Map</span>(<span class="cf">function</span>(x, y) {
      <span class="kw">list</span>(
        <span class="dt">values =</span> x, 
        <span class="dt">range =</span> <span class="kw">range</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), 
        <span class="dt">label =</span> y
      )
    }, d, <span class="kw">names</span>(d), <span class="dt">USE.NAMES =</span> <span class="ot">FALSE</span>)
    
    <span class="kw">plot_ly</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_trace</span>(
        <span class="dt">type =</span> <span class="st">&quot;parcoords&quot;</span>,
        <span class="dt">dimensions =</span> dims
      ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">event_register</span>(<span class="st">&quot;plotly_restyle&quot;</span>)
  })
  
  output<span class="op">$</span>info &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({
    d &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_restyle&quot;</span>)
    <span class="cf">if</span> (<span class="kw">is.null</span>(d)) <span class="st">&quot;Brush along a dimension&quot;</span> <span class="cf">else</span> d
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-parcoords"></span>
<iframe src="https://player.vimeo.com/video/327623322?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.9: Using the <code>"plotly_restyle"</code> event to access brushed dimensions of a parallel coordinates plot. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-parcoords.html" class="uri">https://plotly-r.com/interactives/shiny-parcoords.html</a>
</p>
</div>
<p>As Figure <a href="linking-views-with-shiny.html#fig:shiny-parcoords-data">17.10</a> shows, it’s possible to use this information to infer which data points are highlighted. The logic to do so is fairly sophisticated, and requires accumulation of the event data, as discussed in Section <a href="linking-views-with-shiny.html#reactive-vals">17.2.8</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;event_data_parcoords&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-parcoords-data"></span>
<iframe src="https://player.vimeo.com/video/307598128?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.10: Displaying the highlighted observations of a parcoords trace. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-parcoords-data.html" class="uri">https://plotly-r.com/interactives/shiny-parcoords-data.html</a>
</p>
</div>
</div>
<div id="scoping-events" class="section level3">
<h3><span class="header-section-number">17.2.5</span> Scoping events</h3>
<p>This section leverages the interface for accessing <strong>plotly</strong> input events introduced in Section <a href="linking-views-with-shiny.html#shiny-plotly-inputs">17.2</a> to inform other data views about those events. When managing multiple views that communicate with one another, you’ll need to be aware of which views are a <em>source</em> of interaction and which are a <em>target</em> (a view can be both, at once!). The <code>event_data()</code> function provides a <code>source</code> argument to help refine which view(s) serve as the source of an event. The <code>source</code> argument takes a string ID, and when that ID matches the <code>source</code> of a <code>plot_ly()</code>/<code>ggplotly()</code> graph, then the <code>event_data()</code> is “scoped” to that view. To get a better idea of how this works, consider Figure <a href="linking-views-with-shiny.html#fig:shiny-corrplot">17.11</a></p>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-corrplot">17.11</a> allows one to click on a cell of correlation heatmap to generate a scatterplot of the two corresponding variables – allowing for a closer look at their relationship. In the case of a heatmap, the event data tied to a <code>plotly_click</code> event contains the relevant <code>x</code> and <code>y</code> categories (e.g., the names of the data variables of interest) and the <code>z</code> value (e.g., the pearson correlation between those variables). In order to obtain click data from the heatmap, and only the heatmap, it’s important that the <code>source</code> argument of the <code>event_data()</code> function matches the <code>source</code> argument of <code>plot_ly()</code>. Otherwise, if the <code>source</code> argument was not specified <code>event_data("plotly_click")</code> would also fire if and when the user clicked on the scatterplot, likely causing an error.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

<span class="co"># cache computation of the correlation matrix</span>
correlation &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">cor</span>(mtcars), <span class="dv">3</span>)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;heat&quot;</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;scatterplot&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>heat &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(<span class="dt">source =</span> <span class="st">&quot;heat_plot&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_heatmap</span>(
        <span class="dt">x =</span> <span class="kw">names</span>(mtcars), 
        <span class="dt">y =</span> <span class="kw">names</span>(mtcars), 
        <span class="dt">z =</span> correlation
      )
  })
  
  output<span class="op">$</span>scatterplot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="co"># if there is no click data, render nothing!</span>
    clickData &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;heat_plot&quot;</span>)
    <span class="cf">if</span> (<span class="kw">is.null</span>(clickData)) <span class="kw">return</span>(<span class="ot">NULL</span>)
    
    <span class="co"># Obtain the clicked x/y variables and fit linear model to those 2 vars</span>
    vars &lt;-<span class="st"> </span><span class="kw">c</span>(clickData[[<span class="st">&quot;x&quot;</span>]], clickData[[<span class="st">&quot;y&quot;</span>]])
    d &lt;-<span class="st"> </span><span class="kw">setNames</span>(mtcars[vars], <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))
    yhat &lt;-<span class="st"> </span><span class="kw">fitted</span>(<span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d))
    
    <span class="co"># scatterplot with fitted line</span>
    <span class="kw">plot_ly</span>(d, <span class="dt">x =</span> <span class="op">~</span>x) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>(<span class="dt">y =</span> <span class="op">~</span>y) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_lines</span>(<span class="dt">y =</span> <span class="op">~</span>yhat) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(
        <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> clickData[[<span class="st">&quot;x&quot;</span>]]), 
        <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> clickData[[<span class="st">&quot;y&quot;</span>]]), 
        <span class="dt">showlegend =</span> <span class="ot">FALSE</span>
      )
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-corrplot"></span>
<iframe src="https://player.vimeo.com/video/307597728?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.11: Linking each cell of a correlation heatmap to their corresponding scatterplots. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-corrplot.html" class="uri">https://plotly-r.com/interactives/shiny-corrplot.html</a>
</p>
</div>
</div>
<div id="event-priority" class="section level3">
<h3><span class="header-section-number">17.2.6</span> Event priority</h3>
<p>By default, <code>event_data()</code> only invalidates a reactive expression when the value of it’s corresponding <strong>shiny</strong> input changes. Sometimes, you might want a particular event, say <code>"plotly_click"</code>, to <em>always</em> invalidate a reactive expression. Figure <a href="linking-views-with-shiny.html#fig:event-priority">17.12</a> shows the difference between this default behavior versus setting <code>priority = 'event'</code>. By default, repeatedly clicking the same marker won’t update the clock, but when setting the <code>priority</code> argument to event, repeatedly clicking the same marker will update the clock (i.e., it will invalidate the reactive expression).</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;p&quot;</span>),
  <span class="kw">textOutput</span>(<span class="st">&quot;time1&quot;</span>),
  <span class="kw">textOutput</span>(<span class="st">&quot;time2&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">size =</span> <span class="kw">I</span>(<span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">150</span>)))  <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>()
  })
  
  output<span class="op">$</span>time1 &lt;-<span class="st"> </span><span class="kw">renderText</span>({
    <span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>)
    <span class="kw">paste</span>(<span class="st">&quot;Input priority: &quot;</span>, <span class="kw">Sys.time</span>())
  })
  
  output<span class="op">$</span>time2 &lt;-<span class="st"> </span><span class="kw">renderText</span>({
    <span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">priority =</span> <span class="st">&quot;event&quot;</span>)
    <span class="kw">paste</span>(<span class="st">&quot;Event priority: &quot;</span>, <span class="kw">Sys.time</span>())
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:event-priority"></span>
<iframe src="https://player.vimeo.com/video/307598534?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.12: A demo of input priority versus event priority. Clicking on the same marker repeatedly, by default, won’t invalidate a reactive expression that depends on ‘plotly_click’, but it will invalidate when given event priority. For the interactive, see <a href="https://plotly-r.com/interactives/event-priority.html" class="uri">https://plotly-r.com/interactives/event-priority.html</a>
</p>
</div>
<p>There are numerous events accessible through <code>event_data()</code> that don’t contain any information (e.g., <code>"plotly_doublelick"</code>, <code>"plotly_deselect"</code>, <code>"plotly_afterplot"</code>, etc). These events are automatically given an event priority since their corresponding <strong>shiny</strong> input value never changes. One common use case for events like <code>"plotly_doublelick"</code> (fired when double-clicking in a zoom or pan dragmode) and <code>"plotly_deselect"</code> (fired when double-clicking in a selection mode) is to clear or reset accumulating event data.</p>
</div>
<div id="handling-discrete-axes" class="section level3">
<h3><span class="header-section-number">17.2.7</span> Handling discrete axes</h3>
<p>For events that are trace-specific (e.g. <code>"plotly_click"</code>, <code>"plotly_hover"</code>, <code>"plotly_selecting"</code>, etc), the positional data (e.g., <code>x</code>/<code>y</code>/<code>z</code>) is always numeric, so if you have a plot with discrete axes, you might want to know how to map that numeric value back to the relevant input data category. In some cases, you can avoid the problem by assigning the discrete variable of interest to the <code>key</code>/<code>customdata</code> attribute, but you might also want to reserve that attribute to encode other information, like a <code>fill</code> aesthetic. Figure <a href="linking-views-with-shiny.html#fig:discrete-event-data">17.13</a> shows how to map the numerical <code>x</code> value emitted in a click event back to the discrete variable that it corresponds to (<code>mpg$class</code>) and leverages <code>customdata</code> to encode the <code>fill</code> mapping allowing us to display the data records a clicked bar corresponds to. In both <code>ggplotly()</code> and <code>plot_ly()</code>, categories associated with a character vector are always alphabetized, so if you <code>sort()</code> the <code>unique()</code> character values, then the vector indices will match the <code>x</code> event data values. On the other hand, if <code>x</code> were a factor variable, the <code>x</code> event data would match the ordering of the <code>levels()</code> attribute.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(dplyr)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;bars&quot;</span>),
  <span class="kw">verbatimTextOutput</span>(<span class="st">&quot;click&quot;</span>)
)

classes &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">unique</span>(mpg<span class="op">$</span>class))

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>bars &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">ggplot</span>(mpg, <span class="kw">aes</span>(class, <span class="dt">fill =</span> drv, <span class="dt">customdata =</span> drv)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>()
  })
  
  output<span class="op">$</span>click &lt;-<span class="st"> </span><span class="kw">renderPrint</span>({
    d &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>)
    <span class="cf">if</span> (<span class="kw">is.null</span>(d)) <span class="kw">return</span>(<span class="st">&quot;Click a bar&quot;</span>)
    mpg <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(drv <span class="op">%in%</span><span class="st"> </span>d<span class="op">$</span>customdata) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(class <span class="op">%in%</span><span class="st"> </span>classes[d<span class="op">$</span>x])
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:discrete-event-data"></span>
<iframe src="https://player.vimeo.com/video/307598771?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.13: Retrieving the data observations that correspond to a particular bar in a stacked bar chart. For the interactive, see <a href="https://plotly-r.com/interactives/discrete-event-data.html" class="uri">https://plotly-r.com/interactives/discrete-event-data.html</a>
</p>
</div>
</div>
<div id="reactive-vals" class="section level3">
<h3><span class="header-section-number">17.2.8</span> Accumulating and managing event data</h3>
<p>Currently all the events accessible through <code>event_data()</code> are <em>transient</em>. This means that, given an event like <code>"plotly_click"</code>, the value of <code>event_data()</code> will only reflect the most recent click information. However, in order to implement complex linked graphics with <em>persistent</em> qualities, like Figure <a href="client-side-linking.html#fig:txmissing-modes">16.3</a> or <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a>, you’ll need someway to accumulate and manage event data. The general mechanism that <strong>shiny</strong> provides to achieve this kind of task is <code>reactiveVal()</code> (or, the plural version, <code>reactiveValues()</code>), which essentially provides a way to create and manage input values entirely server-side.</p>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-hover-persist">17.14</a> demonstrates a shiny app that accumulates hover information and paints the hovered points in red. Every time a hover event is triggered, the corresponding car name is added to the set of selected cars, and everytime the plot is double-clicked that set is cleared. This general pattern of initializing a reactive value (i.e., <code>cars &lt;- reactiveVal()</code>), updating that value upon a suitable <code>observeEvent()</code> event with relevant <code>customdata</code>, and clearing that reactive value (i.e., <code>cars(NULL)</code>) in response to another event is a very useful pattern to can support essentially any sort of linked views paradigm because the logic behind the resolution of selection sequences is under your complete control in R. For example, <a href="linking-views-with-shiny.html#fig:shiny-hover-persist">17.14</a> simply adds accumulates the event data from <code>"plotly_hover"</code> (which is like a logical <code>OR</code> operations), but for other applications, you may need different logic, like the <code>AND</code>, <code>XOR</code>, etc.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;event_data_persist&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-hover-persist"></span>
<iframe src="https://player.vimeo.com/video/307597677?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.14: Using <code>reactiveVals()</code> to enable a persistent brush via mouse hover. In this example, the brush can be cleared through a double-click event. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-hover-persist.html" class="uri">https://plotly-r.com/interactives/shiny-hover-persist.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-lmGadget">17.15</a> demonstrates a <strong>shiny</strong> gadget for interactively removing/adding points from a linear model via a scatterplot. A <strong>shiny</strong> gadget is similar to a normal <strong>shiny</strong> app except that it allows you to return object(s) from the application back to into your R session. In this case, Figure <a href="linking-views-with-shiny.html#fig:shiny-lmGadget">17.15</a> returns the fitted model with the outliers removed and the choosen polynomial degree. The logic behind this app does more than simply accumulate event data everytime a point is clicked. Instead, it adds points to the ‘outlier’ set only if it isn’t already an outlier, and removes points that are already in the “outlier” set (so, it’s essentially <code>XOR</code> logic).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;lmGadget&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-lmGadget"></span>
<iframe src="https://player.vimeo.com/video/307598908?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.15: Interactively removing observations from a linear model. Credit to Winston Chang for the initial implementation of this <strong>shiny</strong> gadget using <code>shiny::plotOutput()</code> instead of <code>plotly::plotlyOutput()</code>. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-lmGadget.html" class="uri">https://plotly-r.com/interactives/shiny-lmGadget.html</a>
</p>
</div>
<p>As you can already see, the ability to accumulate and manage event data is a critical skill to have in order to implement <strong>shiny</strong> applications with complex interactive capabilities. The pattern demonstrates here is known more generally as “maintaining state” of a <strong>shiny</strong> app based on user interactions and has a variety of applications. So far, we’ve really only see how to maintain state of a single view, but as we’ll see later in Section <a href="linking-views-with-shiny.html#advanced-applications">17.4</a>, the ability to maintain state is required to implement many advanced applications of multiple linked views. Also, it should be noted that Figure <a href="linking-views-with-shiny.html#fig:shiny-hover-persist">17.14</a> and <a href="linking-views-with-shiny.html#fig:shiny-lmGadget">17.15</a> perform a full redraw when updated – these apps would feel a bit more responsive if they leveraged strategies from Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a>.</p>
</div>
</div>
<div id="shiny-performance" class="section level2">
<h2><span class="header-section-number">17.3</span> Improving performance</h2>
<p>Multiple linked views are known to help facilitate data exploration, but latency in the user interface is also known to reduce exploratory findings <span class="citation">(Heer <a href="#ref-2014-latency" role="doc-biblioref">2014</a>)</span>. In addition to the advice and techniques offered in Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a> for improving <strong>plotly</strong>’s performance in general, there are also techniques specifically for <strong>shiny</strong> apps that you can leverage to help improve the user experience.</p>
<p>When trying to speed-up any slow code, the first step is always to identify the main contributor(s) to the poor performance. In some cases, your intuition may serve as a helpful guide, but in order to <em>really</em> see what’s going on, consider using a code profiling tool like <strong>profvis</strong> <span class="citation">(Chang and Luraschi <a href="#ref-profvis" role="doc-biblioref">2018</a>)</span>. The <strong>profvis</strong> package provides a really nice way to visualize and isolate slow running R code in general, but it also works well for profiling <strong>shiny</strong> apps <span class="citation">(RStudio <a href="#ref-profvis-shiny" role="doc-biblioref">2014</a><a href="#ref-profvis-shiny" role="doc-biblioref">b</a>)</span>.</p>
<p>A lot of different factors can contribute to poor performance in a <strong>shiny</strong> app, but thankfully, the <strong>shiny</strong> ecosystem provides an extensive toolbox for diagnosing and improving performance. The <strong>profvis</strong> package is great for identifying “universal” performance issues, but when deploying shiny apps into production, there may be other potential bottlenecks that surface. This is largely due to R’s single-threaded nature – a single R server has difficulty scaling to many users because, by default, it can only handle one job at a time. The <strong>shinyloadtest</strong> package helps to identify those bottlenecks and <strong>shiny</strong>’s support for asynchronous programming with <strong>promises</strong> is one way to address them without increasing computational infrastructure (e.g. multiple servers) <span class="citation">(Dipert, Schloerke, and Borges <a href="#ref-shinyloadtest" role="doc-biblioref">2018</a>; Cheng <a href="#ref-promises" role="doc-biblioref">2018</a><a href="#ref-promises" role="doc-biblioref">b</a>)</span>.</p>
<p>To reiterate the section on “Improving performance and scalability” in <strong>shiny</strong> from <span class="citation">Cheng (<a href="#ref-async" role="doc-biblioref">2018</a><a href="#ref-async" role="doc-biblioref">a</a>)</span>, you have a number of tools available to address performance:</p>
<ol style="list-style-type: decimal">
<li>The <strong>profvis</strong> package for profiling code.</li>
<li>Cache computations ahead-of-time.</li>
<li>Cache computations at run time.</li>
<li>Cache computations through chaining reactive expressions.</li>
<li>Leverage multiple R processes and/or servers.</li>
<li>Async programming with <strong>promises</strong></li>
</ol>
<p>We won’t directly cover these topics, but it’s worth noting that all these tools are primarily designed for improving <em>server-side</em> performance of a <strong>shiny</strong> app. It could be that sluggish plots in your <strong>shiny</strong> app are due to sluggish server-side code, but it could also be that some of the sluggishness is due to redundant work being done client-side by <strong>plotly</strong>. Avoiding this redundancy, as covered in Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a>, can be difficult, and it doesn’t always lead to noticable improvements. However, when you need to put lots of graphical elements on a plot, then update just a portion of the plot in response to user event(s), the added complexity can be worth the effort.</p>
<div id="proxies" class="section level3">
<h3><span class="header-section-number">17.3.1</span> Partial plotly updates</h3>
<p>By default, when <code>renderPlotly()</code> renders a new <strong>plotly</strong> graph it’s essentially equivalent to executing a block of R code from your R prompt and generating a new <strong>plotly</strong> graph from scratch. That means, not only does the R code need to re-execute to generate a new R object, but it also has to re-serialize that object as JSON, and your browser has to re-render the graph from the new JSON object (more on this in Section <a href="performance.html#performance">24</a>). In cases where your <strong>plotly</strong> graph does not need to serialize a lot data and/or render lots of graphical elements, as in Figure <a href="linking-views-with-shiny.html#fig:shiny-intro">17.1</a>, you can likely perform a full redraw without noticable glitches, especially if you use canvas-based rendering rather than SVG (i.e., <code>toWebGL()</code>). Generally speaking, you should try very hard to make your app responsive before adopting partial <strong>plotly</strong> updates in <strong>shiny</strong>. It makes your app logic easy to reason about because you don’t have to worry about maintaining the state of the graph, but sometimes you have no other choice.</p>
<p>On initial page load, <strong>plotly</strong> graphs must be drawn from stratch, but when responding to certain user events, often times a partial update to an existing plot is sufficient and more responsive. Take, for instance, the difference between Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot">17.16</a>, which does a full redraw on every update, and Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a>, which does a partial update after initial load. Both of these <strong>shiny</strong> apps display a scatterplot with 100,000 points and allow a user to overlay a fitted line through a checkbox. The key difference is that in Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot">17.16</a>, the <strong>plotly</strong> graph is regenerated from scratch everytime the value of <code>input$smooth</code> changes, whereas in Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a> only the fitted line is added/removed from the <strong>plotly</strong>. Since the main bottleneck lies in redrawing the points, Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a> can add/remove the fitted line is a much more responsive fashion.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

<span class="co"># Generate 100,000 observations from 2 correlated random variables</span>
d &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(<span class="fl">1e6</span>, <span class="dt">mu =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">Sigma =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>))
d &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">as.data.frame</span>(d), <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))

<span class="co"># fit a simple linear model</span>
m &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d)

<span class="co"># generate y predictions over a grid of 10 x values</span>
dpred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">x =</span> <span class="kw">seq</span>(<span class="kw">min</span>(d<span class="op">$</span>x), <span class="kw">max</span>(d<span class="op">$</span>x), <span class="dt">length.out =</span> <span class="dv">10</span>)
)
dpred<span class="op">$</span>yhat &lt;-<span class="st"> </span><span class="kw">predict</span>(m, <span class="dt">newdata =</span> dpred)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;scatterplot&quot;</span>),
  <span class="kw">checkboxInput</span>(<span class="st">&quot;smooth&quot;</span>, <span class="dt">label =</span> <span class="st">&quot;Overlay fitted line?&quot;</span>, <span class="dt">value =</span> <span class="ot">FALSE</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>scatterplot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    
    p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(d, <span class="dt">x   =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>(<span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;black&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.05</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">toWebGL</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">showlegend =</span> <span class="ot">FALSE</span>)
    
    <span class="cf">if</span> (<span class="op">!</span>input<span class="op">$</span>smooth) <span class="kw">return</span>(p)
    
    <span class="kw">add_lines</span>(p, <span class="dt">data =</span> dpred, <span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>yhat, <span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;red&quot;</span>))
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-scatterplot"></span>
<iframe src="https://player.vimeo.com/video/327620506?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.16: Naive implementation of a shiny app that optionally overlays a fitted line to a scatterplot. A full redraw of the plot is performed everytime the checkbox is clicked, leading to an unnecessarily slow plot. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-scatterplot.html" class="uri">https://plotly-r.com/interactives/shiny-scatterplot.html</a>
</p>
</div>
<p>In terms of the implementation behind Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot">17.16</a> and <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a>, the only difference resides in the <code>server</code> definition. In Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a>, the <code>renderPlotly()</code> statement no longer has a dependency on input values, so that code is only executed once (on page load) to generate the initial view of the scatterplot. The logic behind adding and removing the fitted line is handled through an <code>observe()</code> block – this reactive expression watches the <code>input$smooth</code> input value and modifies the <code>output$scatterplot</code> widget whenever it changes. To trigger a modification of a <strong>plotly</strong> output widget, you must create a proxy object with <code>plotlyProxy()</code> that references the relevant output ID. Once a proxy object is created, you can invoke any sequence of <a href="https://plot.ly/javascript/plotlyjs-function-reference/#plotlymaketemplate">plotly.js function(s)</a> on it with <code>plotlyProxyInvoke()</code>. Invoking a method with the correct arguments can be tricky and requires knowledge of plotly.js because <code>plotlyProxyInvoke()</code> will send these arguments directly to the plotly.js method and therefore doesn’t support the same ‘high-level’ semantics that <code>plot_ly()</code> does.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r">server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>scatterplot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(d, <span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>(<span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;black&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.05</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">toWebGL</span>()
  })
  
  <span class="kw">observe</span>({
    <span class="cf">if</span> (input<span class="op">$</span>smooth) {
      <span class="co"># this is essentially the plotly.js way of doing</span>
      <span class="co"># `p %&gt;% add_lines(x = ~x, y = ~yhat) %&gt;% toWebGL()`</span>
      <span class="co"># without having to redraw the entire plot</span>
      <span class="kw">plotlyProxy</span>(<span class="st">&quot;scatterplot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plotlyProxyInvoke</span>(
          <span class="st">&quot;addTraces&quot;</span>, 
          <span class="kw">list</span>(
            <span class="dt">x =</span> dpred<span class="op">$</span>x,
            <span class="dt">y =</span> dpred<span class="op">$</span>yhat,
            <span class="dt">type =</span> <span class="st">&quot;scattergl&quot;</span>,
            <span class="dt">mode =</span> <span class="st">&quot;lines&quot;</span>,
            <span class="dt">line =</span> <span class="kw">list</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>)
          )
        )
    } <span class="cf">else</span> {
      <span class="co"># JavaScript index starts at 0, so the &#39;1&#39; here really means</span>
      <span class="co"># &quot;delete the second traces (i.e., the fitted line)&quot;</span>
      <span class="kw">plotlyProxy</span>(<span class="st">&quot;scatterplot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plotlyProxyInvoke</span>(<span class="st">&quot;deleteTraces&quot;</span>, <span class="dv">1</span>)
    }
  })
}</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-scatterplot-performant"></span>
<iframe src="https://player.vimeo.com/video/327621124?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.17: A more responsive version of Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot">17.16</a>. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-scatterplot-performant.html" class="uri">https://plotly-r.com/interactives/shiny-scatterplot-performant.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot">17.16</a> demonstrates a common use case where partial updates can be helpful, but there are other not-so-obvious cases. The next section covers a range of examples where you’ll see how to leverage partial updates to implement smooth ‘streaming’ visuals, avoid resetting axis ranges, avoid flickering basemap layers, and more.</p>
</div>
<div id="partial-update-examples" class="section level3">
<h3><span class="header-section-number">17.3.2</span> Partial update examples</h3>
<p>The last section explains why you may want to leverage partial <strong>plotly</strong> updates in <strong>shiny</strong> to get more responsive updates through an example. That example leveraged the <a href="https://plot.ly/javascript/plotlyjs-function-reference/">plotly.js functions</a> <code>Plotly.addTraces()</code> and <code>Plotly.deleteTraces()</code> to add/remove a layer to a plot after it’s initial draw. There are numerous other plotly.js functions that can be handy for a variety of use cases, some of the most widely used ones are: <code>Plotly.restyle()</code> for updating data visuals (Section <a href="linking-views-with-shiny.html#restyle">17.3.2.1</a>), <code>Plotly.relayout()</code> for updating the layout (Section <a href="linking-views-with-shiny.html#relayout">17.3.2.2</a>), and <code>Plotly.extendTraces()</code> for streaming data (Section <a href="linking-views-with-shiny.html#streaming">17.3.2.3</a>).</p>
<div id="restyle" class="section level4">
<h4><span class="header-section-number">17.3.2.1</span> Modifying traces</h4>
<p>All <strong>plotly</strong> figures have two main components: traces (i.e., mapping from data to visuals) and layout. The plotly.js function <code>Plotly.restyle()</code> is for modifying any existing traces. In addition to being a performant way to modify existing data and/or visual properties, it also has the added benefit of not affecting the current layout of the graph. Notice how, in Figure <a href="linking-views-with-shiny.html#fig:shiny-partial-restyle">17.18</a> for example, when the size of the marker/path changes, it doesn’t change the camera’s view of the 3D plot that the user altered after initial draw. If these input widgets triggered a full redraw of the plot, the camera would be reset to it’s initial state.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;proxy_restyle_economics&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-partial-restyle"></span>
<iframe src="https://player.vimeo.com/video/327621625?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.18: Using <code>Plotly.restyle()</code> to change just the width of a path and markers along that path in response to changes to <strong>shiny</strong> input sliders. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-partial-restyle.html" class="uri">https://plotly-r.com/interactives/shiny-partial-restyle.html</a>
</p>
</div>
<p>One un-intuitive thing about <code>Plotly.restyle()</code> is that it fully replaces object (i.e., attributes that contain attributes) definitions like <code>marker</code> by default. To modify just a particular attribute of an object, like the size of a marker, you must replace that attribute directly (hence <code>marker.size</code>). As mentioned in the <a href="https://plot.ly/javascript/plotlyjs-function-reference/#plotlyrestyle">official documentation</a>, by default, modifications are applied to all traces, but specific traces can be targeted through their trace index (which starts at 0, because JavaScript)!</p>
</div>
<div id="relayout" class="section level4">
<h4><span class="header-section-number">17.3.2.2</span> Updating the layout</h4>
<p>All <strong>plotly</strong> figures have two main components: traces (i.e., mapping from data to visuals) and layout. The plotly.js function <code>Plotly.relayout()</code> modifies the layout component, so it can control a wide variety of things such titles, axis definitions, annotations, shapes, and many other things. It can even be used to change the basemap layer of a Mapbox-powered layout, as in Figure <a href="linking-views-with-shiny.html#fig:shiny-mapbox-relayout">17.19</a>. Note how this example uses <code>schema()</code> to grab all the pre-packaged basemap layers and create a dropdown of those options, but you can also provide a URL to a <a href="https://www.mapbox.com/help/create-a-custom-style/">custom basemap style</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;proxy_mapbox&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-mapbox-relayout"></span>
<iframe src="https://player.vimeo.com/video/327603568?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.19: Using a <code>shiny::selectInput()</code> to modify the basemap style of <code>plot_mapbox()</code> via <code>Plotly.relayout()</code>. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-mapbox-relayout.html" class="uri">https://plotly-r.com/interactives/shiny-mapbox-relayout.html</a>
</p>
</div>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-rangeslider-relayout">17.20</a> demonstrates a clever use of <code>Plotly.relayout()</code> to set the y-axis range in response to changes in the x-axis range.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;proxy_relayout&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-rangeslider-relayout"></span>
<iframe src="https://player.vimeo.com/video/307598689?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.20: Using <code>Plotly.relayout()</code> to ‘auto-range’ the y-axis in response to changes in the x-axis range. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-rangeslider-relayout.html" class="uri">https://plotly-r.com/interactives/shiny-rangeslider-relayout.html</a>
</p>
</div>
</div>
<div id="streaming" class="section level4">
<h4><span class="header-section-number">17.3.2.3</span> Streaming data</h4>
<p>At this point, we’ve seen how to add/remove traces (e.g., add/remove a fitted line, as in Figure <a href="linking-views-with-shiny.html#fig:shiny-scatterplot-performant">17.17</a>), and how to edit specific trace properties (e.g., change marker size or path width, as in Figure <a href="linking-views-with-shiny.html#fig:shiny-partial-restyle">17.18</a>), but what about adding more data to existing trace(s)? This is a job for the plotly.js function <code>Plotly.extendTraces()</code> and/or <code>Plotly.prependTraces()</code> which can used to efficiently ‘stream’ data into an existing plot, as done in Figure <a href="linking-views-with-shiny.html#fig:shiny-stream">17.21</a>.</p>
<p>The implementation behind Figure <a href="linking-views-with-shiny.html#fig:shiny-stream">17.21</a>, an elementary example of a random walk, makes use of some fairly sophisicated reactive programming tools from <strong>shiny</strong>. Similar to most examples from this section, the <code>renderPlotly()</code> statement is executed once on initial load to draw the initial line with just two data points. By default, the plot is not streaming, but streaming can be turned on or off through the click of a button, which will require the app to know (at all times) whether or not we are in a streaming state. One way to do this is to leverage <strong>shiny</strong>’s <code>reactiveValues()</code>, which act like input values, but can be created and modified entirely server-side, making them quite useful for maintaining state of an application. In this case, the reactive value <code>rv$stream</code> is used to store the streaming state, which is turned on/off whenever the <code>actionButton()</code> is clicked (via the <code>observeEvent()</code> logic).</p>
<p>Even if the app is not streaming, there is still constant client/server communication because of the use of <code>invalidateLater()</code> inside the <code>observe()</code>. This effectively tells <strong>shiny</strong> to re-evaluate the <code>observe()</code> block every 100 milliseconds. If the app isn’t in streaming mode, then it exits early without doing anything. If the app is streaming, then we first use <code>sample()</code> to randomly draw either -1 or 1 (with equal probability) and use the result to update the most recent (x, y) state. This is done by assigning a new value to the reactive values <code>rv$y</code> and <code>rv$n</code> within an <code>isolate()</code>d context – if this assignment happened outside of an <code>isolate()</code>d context it would cause the reactive expression to be invalidated and cause an infinite loop! Once we have the new (x, y) point stored away, <code>Plotly.extendTraces()</code> can be used to add the new point to the plotly graph.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;stream&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-stream"></span>
<iframe src="https://player.vimeo.com/video/307598387?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.21: Using <code>Plotly.extendTraces()</code> to efficiently stream data into a plotly chart. This specific example implements a random walk (using R’s random number generator) which updates every 100 milliseconds. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-stream.html" class="uri">https://plotly-r.com/interactives/shiny-stream.html</a>
</p>
</div>
<p>To see more examples that leverage partial updating, see Section <a href="linking-views-with-shiny.html#crossfilter">17.4.2</a>.</p>
</div>
</div>
</div>
<div id="advanced-applications" class="section level2">
<h2><span class="header-section-number">17.4</span> Advanced applications</h2>
<p>This section combines concepts from prior sections in linking views with shiny and applies them towards some popular use cases.</p>
<div id="drill-down" class="section level3">
<h3><span class="header-section-number">17.4.1</span> Drill-down</h3>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-pie">17.22</a> displays sales broken down by business category (e.g, Furniture, Office Supplies, Technology) in a pie chart. It allows the user to click on a slice of the pie to ‘drill-down’ into sub-categories of the chosen category. In terms of the implementation, the key aspect here is to maintain the state of the currently selected category via a <code>reactiveVal()</code> (see more in <a href="linking-views-with-shiny.html#reactive-vals">17.2.8</a>) and update that value when either a category is clicked or the “Back” button is pressed. This may seem like a lot of code to get a basic drill-down pie chart, but the core reactivity concepts in this implementation translate well to more complex drill-down applications.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(purrr) <span class="co"># just for `%||%`</span>

<span class="kw">data</span>(sales, <span class="dt">package =</span> <span class="st">&quot;plotlyBook&quot;</span>)
categories &lt;-<span class="st"> </span><span class="kw">unique</span>(sales<span class="op">$</span>category)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(<span class="kw">plotlyOutput</span>(<span class="st">&quot;pie&quot;</span>), <span class="kw">uiOutput</span>(<span class="st">&quot;back&quot;</span>))

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  <span class="co"># for maintaining the current category (i.e. selection)</span>
  current_category &lt;-<span class="st"> </span><span class="kw">reactiveVal</span>()
  
  <span class="co"># report sales by category, unless a category is chosen</span>
  sales_data &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(<span class="kw">current_category</span>())) {
      <span class="kw">return</span>(<span class="kw">count</span>(sales, category, <span class="dt">wt =</span> sales))
    }
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(category <span class="op">%in%</span><span class="st"> </span><span class="kw">current_category</span>()) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(sub_category, <span class="dt">wt =</span> sales)
  })
  
  <span class="co"># Note that pie charts don&#39;t currently attach the label/value </span>
  <span class="co"># with the click data, but we can leverage `customdata` as a workaround</span>
  output<span class="op">$</span>pie &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    d &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">sales_data</span>(), <span class="kw">c</span>(<span class="st">&quot;labels&quot;</span>, <span class="st">&quot;values&quot;</span>))
    <span class="kw">plot_ly</span>(d) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_pie</span>(<span class="dt">labels =</span> <span class="op">~</span>labels, <span class="dt">values =</span> <span class="op">~</span>values, <span class="dt">customdata =</span> <span class="op">~</span>labels) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="kw">current_category</span>() <span class="op">%||%</span><span class="st"> &quot;Total Sales&quot;</span>)
  })
  
  <span class="co"># update the current category if the clicked value matches a category</span>
  <span class="kw">observe</span>({
    cd &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>)<span class="op">$</span>customdata[[<span class="dv">1</span>]]
    <span class="cf">if</span> (<span class="kw">isTRUE</span>(cd <span class="op">%in%</span><span class="st"> </span>categories)) <span class="kw">current_category</span>(cd)
  })
  
  <span class="co"># populate back button if category is chosen</span>
  output<span class="op">$</span>back &lt;-<span class="st"> </span><span class="kw">renderUI</span>({
    <span class="cf">if</span> (<span class="kw">length</span>(<span class="kw">current_category</span>())) 
      <span class="kw">actionButton</span>(<span class="st">&quot;clear&quot;</span>, <span class="st">&quot;Back&quot;</span>, <span class="kw">icon</span>(<span class="st">&quot;chevron-left&quot;</span>))
  })
  
  <span class="co"># clear the chosen category on back button press</span>
  <span class="kw">observeEvent</span>(input<span class="op">$</span>clear, <span class="kw">current_category</span>(<span class="ot">NULL</span>))
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-drill-down-pie"></span>
<iframe src="https://player.vimeo.com/video/328763167?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.22: A drill-down pie chart of sales by category. By clicking on a category (e.g., Furniture), the pie chart updates to display sales by sub-categories within Furniture. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drill-down-pie.html" class="uri">https://plotly-r.com/interactives/shiny-drill-down-pie.html</a>
</p>
</div>
<p>A basic drill-down like Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-pie">17.22</a> is somewhat useful on its own, but it becomes much more useful when linked to multiple views of the data. Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-bar-time">17.23</a> improves on Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-pie">17.22</a> to show sales over time by the category or sub-category (if a category is currently chosen). Note that the key aspect of implementation remains the same (i.e., maintaining state via <code>reactiveValue()</code>) – the main difference is that the time series view now also responds to changes in the currently selected category. That is, both views show sales by category when no category is selected, and sales by sub-category when a category is selected.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(dplyr)

<span class="kw">data</span>(sales, <span class="dt">package =</span> <span class="st">&quot;plotlyBook&quot;</span>)
categories &lt;-<span class="st"> </span><span class="kw">unique</span>(sales<span class="op">$</span>category)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;bar&quot;</span>),
  <span class="kw">uiOutput</span>(<span class="st">&quot;back&quot;</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;time&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  current_category &lt;-<span class="st"> </span><span class="kw">reactiveVal</span>()
  
  <span class="co"># report sales by category, unless a category is chosen</span>
  sales_data &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(<span class="kw">current_category</span>())) {
      <span class="kw">return</span>(<span class="kw">count</span>(sales, category, <span class="dt">wt =</span> sales))
    }
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(category <span class="op">%in%</span><span class="st"> </span><span class="kw">current_category</span>()) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(sub_category, <span class="dt">wt =</span> sales)
  })
  
  <span class="co"># the pie chart</span>
  output<span class="op">$</span>bar &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    d &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">sales_data</span>(), <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))
    
    <span class="kw">plot_ly</span>(d) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_bars</span>(<span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y, <span class="dt">color =</span> <span class="op">~</span>x) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="kw">current_category</span>() <span class="op">%||%</span><span class="st"> &quot;Total Sales&quot;</span>)
  })
  
  <span class="co"># same as sales_data</span>
  sales_data_time &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(<span class="kw">current_category</span>())) {
      <span class="kw">return</span>(<span class="kw">count</span>(sales, category, order_date, <span class="dt">wt =</span> sales))
    }
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(category <span class="op">%in%</span><span class="st"> </span><span class="kw">current_category</span>()) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(sub_category, order_date, <span class="dt">wt =</span> sales)
  })
  
  output<span class="op">$</span>time &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    d &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">sales_data_time</span>(), <span class="kw">c</span>(<span class="st">&quot;color&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))
    <span class="kw">plot_ly</span>(d) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_lines</span>(<span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y, <span class="dt">color =</span> <span class="op">~</span>color)
  })
  
  <span class="co"># update the current category if the clicked value matches a category</span>
  <span class="kw">observe</span>({
    cd &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>)<span class="op">$</span>x
    <span class="cf">if</span> (<span class="kw">isTRUE</span>(cd <span class="op">%in%</span><span class="st"> </span>categories)) <span class="kw">current_category</span>(cd)
  })
  
  <span class="co"># populate back button if category is chosen</span>
  output<span class="op">$</span>back &lt;-<span class="st"> </span><span class="kw">renderUI</span>({
    <span class="cf">if</span> (<span class="kw">length</span>(<span class="kw">current_category</span>())) 
      <span class="kw">actionButton</span>(<span class="st">&quot;clear&quot;</span>, <span class="st">&quot;Back&quot;</span>, <span class="kw">icon</span>(<span class="st">&quot;chevron-left&quot;</span>))
  })
  
  <span class="co"># clear the chosen category on back button press</span>
  <span class="kw">observeEvent</span>(input<span class="op">$</span>clear, <span class="kw">current_category</span>(<span class="ot">NULL</span>))
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-drill-down-bar-time"></span>
<iframe src="https://player.vimeo.com/video/328768848?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.23: Coordinating drill-down across in multiple views. By clicking on a category (e.g., Technology), both the bar chart and the time-series updates to display sales within Technology. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drill-down-bar-time.html" class="uri">https://plotly-r.com/interactives/shiny-drill-down-bar-time.html</a>
</p>
</div>
<p>Figures <a href="linking-views-with-shiny.html#fig:shiny-drill-down-pie">17.22</a> and <a href="linking-views-with-shiny.html#fig:shiny-drill-down-bar-time">17.23</a> demonstrate one level of drill-down…what about multiple levels? Introducing multiple levels adds complexity not only the implementation, but also the user experience. Especially in a drill-down approach where the <em>same view</em> is being filtered, it can be difficult for the user to remember how they got to a particular view. Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-bar-time-history">17.24</a> demonstrates how we could extend Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-bar-time">17.23</a> to implement yet another level of drilling down (i.e., category -&gt; sub-category -&gt; product IDs) as well as populate a <code>selectInput()</code> dropdown for each active drill-down category. Not only does this help the user to remember how they got to the particular view, but it also provides the ability to easily modify the sequence of drill-down events. In terms of implementation, the main idea is the very similar to before – we still store and update the state of each ‘drill-down’ in it’s own reactive value, but now when a ‘parent’ category changes (e.g., <code>category</code>) it should invalidate (i.e., clear) any currently selected ‘child’ categories (e.g., <code>sub_category</code>).</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)
<span class="kw">library</span>(dplyr)

<span class="kw">data</span>(sales, <span class="dt">package =</span> <span class="st">&quot;plotlyBook&quot;</span>)
categories &lt;-<span class="st"> </span><span class="kw">unique</span>(sales<span class="op">$</span>category)
sub_categories &lt;-<span class="st"> </span><span class="kw">unique</span>(sales<span class="op">$</span>sub_category)
ids &lt;-<span class="st"> </span><span class="kw">unique</span>(sales<span class="op">$</span>id)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">uiOutput</span>(<span class="st">&quot;history&quot;</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;bars&quot;</span>, <span class="dt">height =</span> <span class="dv">200</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;lines&quot;</span>, <span class="dt">height =</span> <span class="dv">300</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  <span class="co"># These reactive values keep track of the drilldown state</span>
  <span class="co"># (NULL means inactive)</span>
  drills &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>(
    <span class="dt">category =</span> <span class="ot">NULL</span>,
    <span class="dt">sub_category =</span> <span class="ot">NULL</span>,
    <span class="dt">id =</span> <span class="ot">NULL</span>
  )
  <span class="co"># filter the data based on active drill-downs</span>
  <span class="co"># also create a column, value, which keeps track of which</span>
  <span class="co"># variable we&#39;re interested in </span>
  sales_data &lt;-<span class="st"> </span><span class="kw">reactive</span>({
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>category)) {
      <span class="kw">return</span>(<span class="kw">mutate</span>(sales, <span class="dt">value =</span> category))
    }
    sales &lt;-<span class="st"> </span><span class="kw">filter</span>(sales, category <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>category)
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>sub_category)) {
      <span class="kw">return</span>(<span class="kw">mutate</span>(sales, <span class="dt">value =</span> sub_category))
    }
    sales &lt;-<span class="st"> </span><span class="kw">filter</span>(sales, sub_category <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>sub_category)
    <span class="kw">mutate</span>(sales, <span class="dt">value =</span> id)
  })
  
  <span class="co"># bar chart of sales by &#39;current level of category&#39;</span>
  output<span class="op">$</span>bars &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    d &lt;-<span class="st"> </span><span class="kw">count</span>(<span class="kw">sales_data</span>(), value, <span class="dt">wt =</span> sales)
    
    p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(d, <span class="dt">x =</span> <span class="op">~</span>value, <span class="dt">y =</span> <span class="op">~</span>n, <span class="dt">source =</span> <span class="st">&quot;bars&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(
        <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;Total Sales&quot;</span>), 
        <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;&quot;</span>)
      )
    
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>sub_category)) {
      <span class="kw">add_bars</span>(p, <span class="dt">color =</span> <span class="op">~</span>value)
    } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>id)) {
      <span class="kw">add_bars</span>(p) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">layout</span>(
          <span class="dt">hovermode =</span> <span class="st">&quot;x&quot;</span>,
          <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">showticklabels =</span> <span class="ot">FALSE</span>)
        )
    } <span class="cf">else</span> {
      <span class="co"># add a visual cue of which ID is selected</span>
      <span class="kw">add_bars</span>(p) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter</span>(value <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>id) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">add_bars</span>(<span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;black&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">layout</span>(
          <span class="dt">hovermode =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">showticklabels =</span> <span class="ot">FALSE</span>),
          <span class="dt">showlegend =</span> <span class="ot">FALSE</span>, <span class="dt">barmode =</span> <span class="st">&quot;overlay&quot;</span>
        )
    }
  })
  
  <span class="co"># time-series chart of the sales</span>
  output<span class="op">$</span>lines &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    p &lt;-<span class="st"> </span><span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>sub_category)) {
      <span class="kw">sales_data</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">count</span>(order_date, value, <span class="dt">wt =</span> sales) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="op">~</span>order_date, <span class="dt">y =</span> <span class="op">~</span>n) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">add_lines</span>(<span class="dt">color =</span> <span class="op">~</span>value)
    } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>id)) {
      <span class="kw">sales_data</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">count</span>(order_date, <span class="dt">wt =</span> sales) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="op">~</span>order_date, <span class="dt">y =</span> <span class="op">~</span>n) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">add_lines</span>()
    } <span class="cf">else</span> {
      <span class="kw">sales_data</span>() <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter</span>(id <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>id) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(<span class="op">-</span>value) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plot_ly</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">add_table</span>()
    }
    p <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(
        <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;Total Sales&quot;</span>), 
        <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;&quot;</span>)
      )
  })
  
  <span class="co"># control the state of the drilldown by clicking the bar graph</span>
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;bars&quot;</span>), {
    x &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;bars&quot;</span>)<span class="op">$</span>x
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(x)) <span class="kw">return</span>()
    
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>category)) {
      drills<span class="op">$</span>category &lt;-<span class="st"> </span>x
    } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>sub_category)) {
      drills<span class="op">$</span>sub_category &lt;-<span class="st"> </span>x
    } <span class="cf">else</span> {
      drills<span class="op">$</span>id &lt;-<span class="st"> </span>x
    }
  })
  
  <span class="co"># populate a `selectInput()` for each active drilldown </span>
  output<span class="op">$</span>history &lt;-<span class="st"> </span><span class="kw">renderUI</span>({
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>category)) <span class="kw">return</span>(<span class="st">&quot;Click the bar chart to drilldown&quot;</span>)
    categoryInput &lt;-<span class="st"> </span><span class="kw">selectInput</span>(
      <span class="st">&quot;category&quot;</span>, <span class="st">&quot;Category&quot;</span>, 
      <span class="dt">choices =</span> categories, <span class="dt">selected =</span> drills<span class="op">$</span>category
    )
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>sub_category)) <span class="kw">return</span>(categoryInput)
    sd &lt;-<span class="st"> </span><span class="kw">filter</span>(sales, category <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>category)
    subCategoryInput &lt;-<span class="st"> </span><span class="kw">selectInput</span>(
      <span class="st">&quot;sub_category&quot;</span>, <span class="st">&quot;Sub-category&quot;</span>, 
      <span class="dt">choices =</span> <span class="kw">unique</span>(sd<span class="op">$</span>sub_category), 
      <span class="dt">selected =</span> drills<span class="op">$</span>sub_category
    )
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">length</span>(drills<span class="op">$</span>id)) {
      <span class="kw">return</span>(<span class="kw">fluidRow</span>(
        <span class="kw">column</span>(<span class="dv">3</span>, categoryInput), 
        <span class="kw">column</span>(<span class="dv">3</span>, subCategoryInput)
      ))
    }
    sd &lt;-<span class="st"> </span><span class="kw">filter</span>(sd, sub_category <span class="op">%in%</span><span class="st"> </span>drills<span class="op">$</span>sub_category)
    idInput &lt;-<span class="st"> </span><span class="kw">selectInput</span>(
      <span class="st">&quot;id&quot;</span>, <span class="st">&quot;Product ID&quot;</span>, 
      <span class="dt">choices =</span> <span class="kw">unique</span>(sd<span class="op">$</span>id), <span class="dt">selected =</span> drills<span class="op">$</span>id
    )
    <span class="kw">fluidRow</span>(
      <span class="kw">column</span>(<span class="dv">3</span>, categoryInput), 
      <span class="kw">column</span>(<span class="dv">3</span>, subCategoryInput),
      <span class="kw">column</span>(<span class="dv">3</span>, idInput)
    )
  })
  
  <span class="co"># control the state of the drilldown via the `selectInput()`s</span>
  <span class="kw">observeEvent</span>(input<span class="op">$</span>category, {
    drills<span class="op">$</span>category &lt;-<span class="st"> </span>input<span class="op">$</span>category
    drills<span class="op">$</span>sub_category &lt;-<span class="st"> </span><span class="ot">NULL</span>
    drills<span class="op">$</span>id &lt;-<span class="st"> </span><span class="ot">NULL</span>
  })
  <span class="kw">observeEvent</span>(input<span class="op">$</span>sub_category, {
    drills<span class="op">$</span>sub_category &lt;-<span class="st"> </span>input<span class="op">$</span>sub_category
    drills<span class="op">$</span>id &lt;-<span class="st"> </span><span class="ot">NULL</span>
  })
  <span class="kw">observeEvent</span>(input<span class="op">$</span>id, {
    drills<span class="op">$</span>id &lt;-<span class="st"> </span>input<span class="op">$</span>id
  })
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-drill-down-bar-time-history"></span>
<iframe src="https://player.vimeo.com/video/328770954?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.24: Coordinating drill-down across in multiple views. By clicking on a category (e.g., Technology), both the bar chart and the time-series updates to display sales within Technology. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drill-down-bar-time.html" class="uri">https://plotly-r.com/interactives/shiny-drill-down-bar-time.html</a>
</p>
</div>
<p>Another way to make it easier for the user to recall their drill-down sequence is to generate a <em>new</em> view based on the selection. Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down">17.25</a> allows one to click on a category (e.g., Furniture) to generate another bar chart of sales broken down by that category’s sub-categories (e.g., Bookcases, Chairs, etc). From there, a sub-category may be clicked to populate a time series of sales for that sub-category. Finally, by clicking on the time series, a table of sales from that date are displayed.</p>
<p>Similar to Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down-bar-time-history">17.24</a>, changes at a given category level causes invalidation of all child categories (in this case, all downstream views are cleared). For example, note how in Figure <a href="linking-views-with-shiny.html#fig:shiny-drill-down">17.25</a>, a click of a category clears the sub-category and order-date. Moreover, a change in <code>sub_category</code> clears the <code>order_date</code>, but effect the current <code>category</code>.</p>
<details>
<p><summary>Click to show/hide the code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)
<span class="kw">library</span>(dplyr)

<span class="kw">data</span>(sales, <span class="dt">package =</span> <span class="st">&quot;plotlyBook&quot;</span>)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;category&quot;</span>, <span class="dt">height =</span> <span class="dv">200</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;sub_category&quot;</span>, <span class="dt">height =</span> <span class="dv">200</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;sales&quot;</span>, <span class="dt">height =</span> <span class="dv">300</span>),
  <span class="kw">dataTableOutput</span>(<span class="st">&quot;datatable&quot;</span>)
)

<span class="co"># avoid repeating this code</span>
axis_titles &lt;-<span class="st"> </span>. <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">layout</span>(
    <span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;&quot;</span>),
    <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">&quot;Sales&quot;</span>)
  )

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  <span class="co"># for maintaining the state of drill-down variables</span>
  category &lt;-<span class="st"> </span><span class="kw">reactiveVal</span>()
  sub_category &lt;-<span class="st"> </span><span class="kw">reactiveVal</span>()
  order_date &lt;-<span class="st"> </span><span class="kw">reactiveVal</span>()
  
  <span class="co"># when clicking on a category, </span>
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;category&quot;</span>), {
    <span class="kw">category</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;category&quot;</span>)<span class="op">$</span>x)
    <span class="kw">sub_category</span>(<span class="ot">NULL</span>)
    <span class="kw">order_date</span>(<span class="ot">NULL</span>)
  })
  
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;sub_category&quot;</span>), {
    <span class="kw">sub_category</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;sub_category&quot;</span>)<span class="op">$</span>x)
    <span class="kw">order_date</span>(<span class="ot">NULL</span>)
  })
  
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;order_date&quot;</span>), {
    <span class="kw">order_date</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_click&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;order_date&quot;</span>)<span class="op">$</span>x)
  })
  
  output<span class="op">$</span>category &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(category, <span class="dt">wt =</span> sales) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="op">~</span>category, <span class="dt">y =</span> <span class="op">~</span>n, <span class="dt">source =</span> <span class="st">&quot;category&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">axis_titles</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="st">&quot;Sales by category&quot;</span>)
  })
  
  output<span class="op">$</span>sub_category &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="cf">if</span> (<span class="kw">is.null</span>(<span class="kw">category</span>())) <span class="kw">return</span>(<span class="ot">NULL</span>)
    
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(category <span class="op">%in%</span><span class="st"> </span><span class="kw">category</span>()) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(sub_category, <span class="dt">wt =</span> sales) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="op">~</span>sub_category, <span class="dt">y =</span> <span class="op">~</span>n, <span class="dt">source =</span> <span class="st">&quot;sub_category&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">axis_titles</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="kw">category</span>())
  })
  
  output<span class="op">$</span>sales &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="cf">if</span> (<span class="kw">is.null</span>(<span class="kw">sub_category</span>())) <span class="kw">return</span>(<span class="ot">NULL</span>)
    
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(sub_category <span class="op">%in%</span><span class="st"> </span><span class="kw">sub_category</span>()) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">count</span>(order_date, <span class="dt">wt =</span> sales) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> <span class="op">~</span>order_date, <span class="dt">y =</span> <span class="op">~</span>n, <span class="dt">source =</span> <span class="st">&quot;order_date&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_lines</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">axis_titles</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="kw">paste</span>(<span class="kw">sub_category</span>(), <span class="st">&quot;sales over time&quot;</span>))
  })
  
  output<span class="op">$</span>datatable &lt;-<span class="st"> </span><span class="kw">renderDataTable</span>({
    <span class="cf">if</span> (<span class="kw">is.null</span>(<span class="kw">order_date</span>())) <span class="kw">return</span>(<span class="ot">NULL</span>)
    
    sales <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(
        sub_category <span class="op">%in%</span><span class="st"> </span><span class="kw">sub_category</span>(),
        <span class="kw">as.Date</span>(order_date) <span class="op">%in%</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">order_date</span>())
      )
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-drill-down"></span>
<iframe src="https://player.vimeo.com/video/307597838?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.25: Using a drill-down approach to navigating through sales data by category, sub-category, and order date. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drill-down.html" class="uri">https://plotly-r.com/interactives/shiny-drill-down.html</a>
</p>
</div>
</div>
<div id="crossfilter" class="section level3">
<h3><span class="header-section-number">17.4.2</span> Cross-filter</h3>
<p>Somewhat related to the drill-down idea is so-called ‘cross-filter’ chart. The main difference between drill-down and cross-filter is that, with cross-filter, interactions don’t generate new charts – interactions impose a filter on the data shown in a fixed set of multiple views. The typical cross-filter implementation allows for multiple brushes (i.e., filters) and uses the intersection of those filters to the dataset displayed in those views. Implementing a scalable and responsive crossfilter with 3 or more views can get quite complicated – we’ll walk through some simple examples first for learning purposes, then progress to more sophicated and complex applications.</p>
<p>Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-naive">17.26</a> demonstrates the simplest way to implement a cross-filter between <em>two</em> histograms. It uses the arrival (<code>arr_time</code>) and departure (<code>dep_time</code>) from the <code>flights</code> dataset via the <strong>nycflights13</strong> package <span class="citation">(Wickham <a href="#ref-nycflights13" role="doc-biblioref">2018</a><a href="#ref-nycflights13" role="doc-biblioref">a</a>)</span>. Notice how, in the implementation, the <code>dep_time</code> view is re-drawn from stratch everytime the <code>arr_time</code> brush changes (and vice-versa). Not only is it completely redrawn (i.e., it relies on <code>renderPlotly()</code> to perform the update), but it also uses <code>add_histogram()</code> which performs binning client-side (in the web browser). That means, every time a brush changes, the <strong>shiny</strong> server sends <em>all the raw data</em> to the browser and plotly.js redraws the histogram from scratch.</p>
<details>
<p><summary>Click to show code</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(nycflights13)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;arr_time&quot;</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;dep_time&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>arr_time &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(flights, <span class="dt">x =</span> <span class="op">~</span>arr_time, <span class="dt">source =</span> <span class="st">&quot;arr_time&quot;</span>) 
    
    brush &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_brushing&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;dep_time&quot;</span>)
    <span class="cf">if</span> (<span class="kw">is.null</span>(brush)) <span class="kw">return</span>(p)
    
    p <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(<span class="kw">between</span>(dep_time, brush<span class="op">$</span>x[<span class="dv">1</span>], brush<span class="op">$</span>x[<span class="dv">2</span>])) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_histogram</span>()
  })
  
  output<span class="op">$</span>dep_time &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(flights, <span class="dt">x =</span> <span class="op">~</span>dep_time, <span class="dt">source =</span> <span class="st">&quot;dep_time&quot;</span>) 
    
    brush &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_brushing&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;arr_time&quot;</span>)
    <span class="cf">if</span> (<span class="kw">is.null</span>(brush)) <span class="kw">return</span>(p)
    
    p <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(<span class="kw">between</span>(arr_time, brush<span class="op">$</span>x[<span class="dv">1</span>], brush<span class="op">$</span>x[<span class="dv">2</span>])) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_histogram</span>()
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<div class="figure" style="text-align: center"><span id="fig:shiny-crossfilter-naive"></span>
<iframe src="https://player.vimeo.com/video/318277110?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.26: A ‘naive’ crossfilter implementation linking arrival time with departure time of about 350,000 <code>flights</code> from the <strong>nycflights13</strong> package. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-crossfilter-naive.html" class="uri">https://plotly-r.com/interactives/shiny-crossfilter-naive.html</a>
</p>
</div>
<p>Although the video behind Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-naive">17.26</a> demonstrates the app is fairly responsive at 350,000 observations, this implementation won’t scale to much larger data, especially if being viewed a poor internet connection. I call this a ‘naive’ implementation because the reactive logic is easy to reason about, but it illustrates two common issues that we can address to gain speed improvements:</p>
<ol style="list-style-type: decimal">
<li>More data than necessary being sent ‘over-the-wire’ (i.e., between the server and the client). This idea is not unique to <strong>shiny</strong> applications – with any web application framework it’s important to minimize the amount of data you’re requesting from a server if you want a responsive website.</li>
<li>More client-side rendering work than necessary to achieve the request update.</li>
</ol>
<p>The implementation behind Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-naive">17.26</a> could improve in these areas by doing the following:</p>
<ol style="list-style-type: decimal">
<li>Perform the binning server-side instead of client-side. This will reduce the amount of data needed to be sent from server to client so that responsiveness is less dependent on a good internet connection. Here we propose using <strong>ggstat</strong> for the server-side binning since it’s fairly fast and simple if you’re data can fit into memory <span class="citation">(Wickham <a href="#ref-ggstat" role="doc-biblioref">2016</a>)</span>. If your data does not fit into memory you could use something like <strong>dbplot</strong> to perform the binning in a database <span class="citation">(Ruiz <a href="#ref-dbplot" role="doc-biblioref">2018</a>)</span>.</li>
<li>Perform less rendering work client-side. That is, instead of relying on <code>renderPlotly()</code> to re-render the chart from scratch everytime the charts need an update, we could instead modify just the bar heights (using the techniques from Section <a href="linking-views-with-shiny.html#proxies">17.3.1</a>).</li>
</ol>
<details>
<p><summary>Click to below to see the responsive implementation</summary></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(nycflights13)
<span class="kw">library</span>(ggstat)

arr_time &lt;-<span class="st"> </span>flights<span class="op">$</span>arr_time
dep_time &lt;-<span class="st"> </span>flights<span class="op">$</span>dep_time
arr_bins &lt;-<span class="st"> </span><span class="kw">bin_fixed</span>(arr_time, <span class="dt">bins =</span> <span class="dv">250</span>)
dep_bins &lt;-<span class="st"> </span><span class="kw">bin_fixed</span>(dep_time, <span class="dt">bins =</span> <span class="dv">250</span>)
arr_stats &lt;-<span class="st"> </span><span class="kw">compute_stat</span>(arr_bins, arr_time) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(xmin_))
dep_stats &lt;-<span class="st"> </span><span class="kw">compute_stat</span>(dep_bins, dep_time) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(xmin_))

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;arr_time&quot;</span>, <span class="dt">height =</span> <span class="dv">250</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;dep_time&quot;</span>, <span class="dt">height =</span> <span class="dv">250</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>arr_time &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(arr_stats, <span class="dt">source =</span> <span class="st">&quot;arr_time&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_bars</span>(<span class="dt">x =</span> <span class="op">~</span>xmin_, <span class="dt">y =</span> <span class="op">~</span>count_) 
  })
  
  output<span class="op">$</span>dep_time &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(dep_stats, <span class="dt">source =</span> <span class="st">&quot;dep_time&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_bars</span>(<span class="dt">x =</span> <span class="op">~</span>xmin_, <span class="dt">y =</span> <span class="op">~</span>count_) 
  })
  
  <span class="co"># arr_time brush updates dep_time view</span>
  <span class="kw">observe</span>({
    brush &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_brushing&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;arr_time&quot;</span>)
    p &lt;-<span class="st"> </span><span class="kw">plotlyProxy</span>(<span class="st">&quot;dep_time&quot;</span>, session)
    
    <span class="co"># if brush is empty, restore default</span>
    <span class="cf">if</span> (<span class="kw">is.null</span>(brush)) {
      <span class="kw">plotlyProxyInvoke</span>(p, <span class="st">&quot;restyle&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="kw">list</span>(dep_stats<span class="op">$</span>count_), <span class="dv">0</span>)
    } <span class="cf">else</span> {
      dep_time_filter &lt;-<span class="st"> </span>dep_time[<span class="kw">between</span>(dep_time, brush<span class="op">$</span>x[<span class="dv">1</span>], brush<span class="op">$</span>x[<span class="dv">2</span>])]
      dep_count &lt;-<span class="st"> </span>dep_bins <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">compute_stat</span>(dep_time_filter) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(xmin_)) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">pull</span>(count_)
      
      <span class="kw">plotlyProxyInvoke</span>(p, <span class="st">&quot;restyle&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="kw">list</span>(dep_count), <span class="dv">0</span>)
    }
  })
  
  <span class="kw">observe</span>({
    brush &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_brushing&quot;</span>, <span class="dt">source =</span> <span class="st">&quot;dep_time&quot;</span>)
    p &lt;-<span class="st"> </span><span class="kw">plotlyProxy</span>(<span class="st">&quot;arr_time&quot;</span>, session)
    
    <span class="co"># if brush is empty, restore default</span>
    <span class="cf">if</span> (<span class="kw">is.null</span>(brush)) {
      <span class="kw">plotlyProxyInvoke</span>(p, <span class="st">&quot;restyle&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="kw">list</span>(arr_stats<span class="op">$</span>count_), <span class="dv">0</span>)
    } <span class="cf">else</span> {
      arr_time_filter &lt;-<span class="st"> </span>arr_time[<span class="kw">between</span>(arr_time, brush<span class="op">$</span>x[<span class="dv">1</span>], brush<span class="op">$</span>x[<span class="dv">2</span>])]
      arr_count &lt;-<span class="st"> </span>arr_bins <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">compute_stat</span>(arr_time_filter) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(xmin_)) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">pull</span>(count_)
      
      <span class="kw">plotlyProxyInvoke</span>(p, <span class="st">&quot;restyle&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="kw">list</span>(arr_count), <span class="dv">0</span>)
    }
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
</details>
<p>Before we address the additional complexity that comes with linking 3 or more views, let’s consider targetting a 2D distribution in the cross-filter, as in Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-kde">17.27</a>. This approach uses <code>kde2d()</code> from the <strong>MASS</strong> package to summarize the 2D distribution server-side rather than attempting to show all the raw data in a scatterplot.<a href="#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;crossfilter_kde&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-crossfilter-kde"></span>
<iframe src="https://player.vimeo.com/video/318122403?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.27: Using kernel density estimation to responsively crossfilter a 2D distribution. This particular example shows how the relationship between diamond carat and price is dependent upon it’s depth. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-crossfilter-kde.html" class="uri">https://plotly-r.com/interactives/shiny-crossfilter-kde.html</a>
</p>
</div>
<p>When linking 3 or more views in a crossfilter, it’s important to have a mechanism to maintain the state of all the active brushes. This is because, when updating a given view, it needs to know about <em>all</em> of the active brushes. The implementation behind Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a> maintains the range of every active brush through a <code>reactiveValues()</code> variable named <code>brush_ranges</code>. Everytime a brush changes, the state of <code>brush_ranges</code> is updated, then used to filter the data down to the relevant observations. That filtered data is then binned and used to modify the bar heights of every view (except for the one being brushed).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;crossfilter&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-crossfilter"></span>
<iframe src="https://player.vimeo.com/video/318129502?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.28: Crossfiltering 6 variables in the <code>flights</code> data from the <strong>nycflights13</strong> package <span class="citation">(Wickham <a href="#ref-nycflights13" role="doc-biblioref">2018</a><a href="#ref-nycflights13" role="doc-biblioref">a</a>)</span>. The filtering and binning logic occurs server-side resulting in a very minimal amount of data being sent between server and client (just the brush range and bar heights). Moreover, to perform the UI update, the client only has to tweak existing bar heights, so the overall user experience is quite responsive. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-crossfilter.html" class="uri">https://plotly-r.com/interactives/shiny-crossfilter.html</a>
</p>
</div>
<p>One weakness of a typical crossfilter interface like Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a> is that it’s difficult to make visual comparisons. That is, when a filter is applied, you lose a visual reference to the overall distribution and/or prior filter, making difficult to make meaningful comparisons. Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a> modifies the logic of Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-compare">17.29</a> to enable filter comparisons by adding the ability to change the color of the brush. Moreover, for sake of demonstration and simplicity, it also allows for only one active filter per color (i.e., brushing within color is transient). One could borrow logic from Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a> to allow multiple filters for each color, but this would require multiple <code>brush_ranges</code>.</p>
<p>Since brushing within color is transient, in constrast to Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a>, Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter-compare">17.29</a> doesn’t have to track the state of all the active brushes. It does, however, need to display <em>relative</em> rather than absolute frequencies to facilitate comparison of small filter range(s) to the overall distribution. This particular implementation takes the overall distribution as a “base layer” that remains fixed and overlays a handful of “selection layers” – one for each possible brush color. These selection layers begin with a height of 0, but when the relevant brush fires the heights of the bars for the relevant layer is modified. This approach may seem like a hack, but it leads to a fluid user experience because it’s not much work to adjust the height of a bar that already exists.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;crossfilter_compare&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-crossfilter-compare"></span>
<iframe src="https://player.vimeo.com/video/327622610?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.29: Comparing filters with a dynamic color brush. This particular example compares ‘red eye’ flights (in green) to early morning flights (in orange). This makes it easier to see that delays occur more often for ‘red eye’ flights. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-crossfilter-compare.html" class="uri">https://plotly-r.com/interactives/shiny-crossfilter-compare.html</a>
</p>
</div>
</div>
<div id="drag-brush" class="section level3">
<h3><span class="header-section-number">17.4.3</span> A draggable brush</h3>
<p>A <em>draggable</em> linked brush is great for conditioning via a moving window. For example, in a cross-filtering example like Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a>, it would be nice to condition on a certain hour of day, then drag that hour interval along the axis to explore how the hourly distribution changes throughout the day. At the time of writing, plotly.js does not support a draggable brush, but we could implement one with a clever use of a editable rectangle shape. Figure <a href="linking-views-with-shiny.html#fig:shiny-drag-brush">17.30</a> demonstrates this idea in a <strong>shiny</strong> application by drawing a rectangle shape that mimics the plotly.js brush, then uses the <code>"plotly_relayout"</code> event to determine the limits of the brush (instead of the <code>"plotly_brushed"</code> or <code>"plotly_brushing"</code>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotly_example</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;drag_brush&quot;</span>)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:shiny-drag-brush"></span>
<iframe src="https://player.vimeo.com/video/318330112?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.30: A draggable brush with both a transient and persistent mode. The dragging ability is done by mimicing the native plotly.js brush with an editable rectangle shape and listening to changes in that brush. The implementation of transient vs persistent mode is a matter of forgetting or remembering previous state(s) of the brush. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-drag-brush.html" class="uri">https://plotly-r.com/interactives/shiny-drag-brush.html</a>
</p>
</div>
</div>
</div>
<div id="discussion" class="section level2">
<h2><span class="header-section-number">17.5</span> Discussion</h2>
<p>Compared to the linking framework covered in Section <a href="client-side-linking.html#graphical-queries">16.1</a>, the ability to link views server-side with <strong>shiny</strong> opens the door to many new possibilities. This chapter focuses mostly on using just <strong>plotly</strong> within <strong>shiny</strong>, but the <strong>shiny</strong> ecosystem is vast and these techniques can of course be used to inform other views, such as static plots, other <strong>htmlwidgets</strong> packages (e.g., <strong>leaflet</strong>, <strong>DT</strong>, <strong>network3D</strong>, etc), and other custom <strong>shiny</strong> bindings. In fact, I have a numerous <strong>shiny</strong> apps publically available via an R package that use numerous tools to provide exploratory interfaces to a variety of domain-specific problems, including <code>zikar::explore()</code> for exploring Zika virus reports, <code>eechidna::launch()</code> for exploring Australian election and census data, and <code>bcviz::launch()</code> for exploring housing and census information in British Colombia <span class="citation">(Sievert <a href="#ref-zikar" role="doc-biblioref">2018</a><a href="#ref-zikar" role="doc-biblioref">d</a>, <a href="#ref-bcviz" role="doc-biblioref">2018</a><a href="#ref-bcviz" role="doc-biblioref">a</a>; Cook et al. <a href="#ref-eechidna" role="doc-biblioref">2017</a>)</span>. These complex applications also serve as a reference as to how can use the client-side linking framework (i.e., <strong>crosstalk</strong>) inside a larger <strong>shiny</strong> application. See this video for an example:</p>
<div class="figure" style="text-align: center"><span id="fig:shiny-crosstalk-examples"></span>
<iframe src="https://player.vimeo.com/video/207379729?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 17.31: Example of a <strong>shiny</strong> app that has <strong>crosstalk</strong> functionality embedded. For the interactive, see <a href="https://plotly-r.com/interactives/shiny-crosstalk-examples.html" class="uri">https://plotly-r.com/interactives/shiny-crosstalk-examples.html</a>
</p>
</div>
<p>Sometimes <strong>shiny</strong> gets a bad rap for being too slow or unresponsive, but as we learned in sections <a href="linking-views-with-shiny.html#proxies">17.3.1</a> and <a href="linking-views-with-shiny.html#advanced-applications">17.4</a>, we can still have very advanced functionality as well as a good user experience – it just takes a bit more effort to optimize performance in some cases. In fact, one could argue that a server-client approach to crossfiltering, as done in Figure <a href="linking-views-with-shiny.html#fig:shiny-crossfilter">17.28</a> is more scalable than a purely client-side approach since the client wouldn’t need to know about the raw data – just the summary statistics. Nevertheless, sometimes linking views server side simply isn’t an option for you or your organization.</p>
<p>Maybe your IT administrator simply won’t allow you to distribute your work outside of a standalone HTML file. Figure <a href="linking-views-with-shiny.html#fig:shiny-corrplot">17.11</a> is just one example of a linked graphic that <em>could</em> be replicated using the graphical querying framework from Section <a href="client-side-linking.html#graphical-queries">16.1</a>, but it would require pre-computing every possible view (which becomes un-manageable when there are many possible selections) and posing the update logic as a database query. When users are only allowed to select (e.g. click/hover) a single element at a time, the number of possible selections increases linearly with the number of elements, but when users are allowed to select any subset of elements (e.g., scatterplot brushing), the number of possible selection explodes (increases at a factorial rate). For example, adding a cell to Figure <a href="linking-views-with-shiny.html#fig:shiny-corrplot">17.11</a> only adds one possible selection, but if we added more states to Figure <a href="linking-views-with-shiny.html#fig:shiny-corrplot">17.11</a>, the number of possible states goes from 50! to 51!.</p>
<p>Even in the case that you need a standalone HTML file and the R API that <strong>plotly</strong> provides doesn’t support the type of interactivity that you desire, you can always layer on additional JavaScript to hopefully achieve the functionality you desire. This can be useful for something as simple as opening a hyperlink when clicking on marker of a plotly graph – this topic is covered introduced in Chapter <a href="javascript.html#javascript">18</a>.</p>

</div>
</div>



<h3>References</h3>
<div id="refs" class="references">
<div id="ref-shiny-plot-interaction">
<p>Chang, Winston. 2017. “Interactive Plots (in Shiny).” Blog. <a href="http://shiny.rstudio.com/articles/plot-interaction.html">http://shiny.rstudio.com/articles/plot-interaction.html</a>.</p>
</div>
<div id="ref-shinydashboard">
<p>Chang, Winston, and Barbara Borges Ribeiro. 2018. <em>Shinydashboard: Create Dashboards with ’Shiny’</em>. <a href="https://CRAN.R-project.org/package=shinydashboard">https://CRAN.R-project.org/package=shinydashboard</a>.</p>
</div>
<div id="ref-profvis">
<p>Chang, Winston, and Javier Luraschi. 2018. <em>Profvis: Interactive Visualizations for Profiling R Code</em>. <a href="https://CRAN.R-project.org/package=profvis">https://CRAN.R-project.org/package=profvis</a>.</p>
</div>
<div id="ref-async">
<p>Cheng, Joe. 2018a. “Case Study: Converting a Shiny App to Async.” Blog. <a href="https://rstudio.github.io/promises/articles/casestudy.html">https://rstudio.github.io/promises/articles/casestudy.html</a>.</p>
</div>
<div id="ref-promises">
<p>Cheng, Joe. 2018b. <em>Promises: Abstractions for Promise-Based Asynchronous Programming</em>. <a href="https://CRAN.R-project.org/package=promises">https://CRAN.R-project.org/package=promises</a>.</p>
</div>
<div id="ref-leaflet-shiny">
<p>Cheng, Joe. 2018c. <em>Using Leaflet with Shiny</em>. Blog. <a href="https://rstudio.github.io/leaflet/shiny.html">https://rstudio.github.io/leaflet/shiny.html</a>.</p>
</div>
<div id="ref-eechidna">
<p>Cook, Di, Anthony Ebert, Heike Hofmann, Rob Hyndman, Thomas Lumley, Ben Marwick, Carson Sievert, et al. 2017. <em>Eechidna: Exploring Election and Census Highly Informative Data Nationally for Australia</em>. <a href="https://CRAN.R-project.org/package=eechidna">https://CRAN.R-project.org/package=eechidna</a>.</p>
</div>
<div id="ref-shinyloadtest">
<p>Dipert, Alan, Barret Schloerke, and Barbara Borges. 2018. <em>Shinyloadtest: Load Test Shiny Applications</em>.</p>
</div>
<div id="ref-2014-latency">
<p>Heer, Zhicheng Liu AND Jeffrey. 2014. “The Effects of Interactive Latency on Exploratory Visual Analysis.” <em>IEEE Trans. Visualization &amp; Comp. Graphics (Proc. InfoVis)</em>. <a href="http://idl.cs.washington.edu/papers/latency">http://idl.cs.washington.edu/papers/latency</a>.</p>
</div>
<div id="ref-sass">
<p>Mastny, Timothy. 2018. <em>Sass: Syntactically Awesome Stylesheets (Sass) Compiler</em>. <a href="https://github.com/rstudio/sass">https://github.com/rstudio/sass</a>.</p>
</div>
<div id="ref-shiny-custom-inputs">
<p>RStudio. 2014a. “Build Custom Input Objects.” Blog. <a href="https://shiny.rstudio.com/articles/building-inputs.html">https://shiny.rstudio.com/articles/building-inputs.html</a>.</p>
</div>
<div id="ref-profvis-shiny">
<p>RStudio. 2014b. “Profvis — Interactive Visualizations for Profiling R Code.” Blog. <a href="https://rstudio.github.io/profvis/examples.html">https://rstudio.github.io/profvis/examples.html</a>.</p>
</div>
<div id="ref-dbplot">
<p>Ruiz, Edgar. 2018. <em>Dbplot: Simplifies Plotting Data Inside Databases</em>. <a href="https://CRAN.R-project.org/package=dbplot">https://CRAN.R-project.org/package=dbplot</a>.</p>
</div>
<div id="ref-bcviz">
<p>Sievert, Carson. 2018a. <em>Bcviz: A Shiny App for Exploring Bc Housing and Census Data</em>. <a href="https://github.com/cpsievert/bcviz">https://github.com/cpsievert/bcviz</a>.</p>
</div>
<div id="ref-zikar">
<p>Sievert, Carson. 2018d. <em>Zikar: Tools for Exploring Publicly Available Zika Data</em>. <a href="https://github.com/cpsievert/zikar">https://github.com/cpsievert/zikar</a>.</p>
</div>
<div id="ref-ggstat">
<p>Wickham, Hadley. 2016. <em>Ggstat: Statistical Computations for Visualisation</em>. <a href="https://github.com/hadley/ggstat">https://github.com/hadley/ggstat</a>.</p>
</div>
<div id="ref-nycflights13">
<p>Wickham, Hadley. 2018a. <em>Nycflights13: Flights That Departed Nyc in 2013</em>. <a href="https://CRAN.R-project.org/package=nycflights13">https://CRAN.R-project.org/package=nycflights13</a>.</p>
</div>
<div id="ref-DT-shiny">
<p>Xie, Yihui. 2018. <em>Using Leaflet with Shiny</em>. Blog. <a href="https://rstudio.github.io/DT/shiny.html">https://rstudio.github.io/DT/shiny.html</a>.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="29">
<li id="fn29"><p>Read more about <strong>shiny</strong>’s responsive layout here <a href="https://shiny.rstudio.com/articles/layout-guide.html" class="uri">https://shiny.rstudio.com/articles/layout-guide.html</a><a href="linking-views-with-shiny.html#fnref29" class="footnote-back">↩</a></p></li>
<li id="fn30"><p>Read more about using custom HTML templates here <a href="https://shiny.rstudio.com/articles/html-ui.html" class="uri">https://shiny.rstudio.com/articles/html-ui.html</a><a href="linking-views-with-shiny.html#fnref30" class="footnote-back">↩</a></p></li>
<li id="fn31"><p>The <code>plotly_build()</code> function is an S3 generic, so you can list all relevant the methods with <code>methods(plotly_build)</code>, and write you’re own method to translate a custom object to <strong>plotly</strong>.<a href="linking-views-with-shiny.html#fnref31" class="footnote-back">↩</a></p></li>
<li id="fn32"><p>In order to convert <strong>grid</strong> grobs that are relatively sized, the <code>ggplotly()</code> function uses the size of the current graphics device at print-time, meaning that resizing the browser window without a hook back to R can create wonky sizes.<a href="linking-views-with-shiny.html#fnref32" class="footnote-back">↩</a></p></li>
<li id="fn33"><p>These events are documented at <a href="https://plot.ly/javascript/plotlyjs-events/" class="uri">https://plot.ly/javascript/plotlyjs-events/</a><a href="linking-views-with-shiny.html#fnref33" class="footnote-back">↩</a></p></li>
<li id="fn34"><p>It’s possible to do this responsively with about 50,000 observations, but it won’t scale to anything much larger than that. Run <code>plotly_example("shiny", "crossfilter_scatter")</code> to see it action as well as a corresponding video at <a href="https://vimeo.com/318129005" class="uri">https://vimeo.com/318129005</a><a href="linking-views-with-shiny.html#fnref34" class="footnote-back">↩</a></p></li>
</ol>
</div>
<script>
  var header = document.querySelector(".book-header");

  var img = document.createElement("img");
  img.src = "images/rstudioCloud.svg";
  img.width = 200;
  img.align = "right";
  img.style = "margin-top:10px; float:right";

  var a = document.createElement("a");
  a.href = "https://rstudio.cloud/project/156701";
  a.target = "_blank";

  a.appendChild(img);
  header.appendChild(a);
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-60116966-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-60116966-3');
</script>
<script>
window.onload = function() {

  var imgs = document.querySelectorAll('img');

  // Upon clicking an image, open a new window with the
  // dimensions of the image, pointing the `data-url` link
  var on_click = function (e) {
    var d = e.target.dataset || {};
    if (d.url) {
      // Add some extra height for the modebar
      var height = 'height=' + (e.target.clientHeight * 1.05);
      var width = 'width=' + e.target.clientWidth;
      var param = 'location=yes,' + height + ',' + width + ',scrollbars=yes,status=yes';
      window.open(e.target.dataset.url, '_blank', param);
    }
  };

  var on_hover = function (e) {
    var d = e.target.dataset || {};
    if (d.url) {
      e.target.style.cursor = 'pointer';
    }
  };

  for (var i = 0; i < imgs.length; i++) {
    imgs[i].addEventListener('click', on_click);
    imgs[i].addEventListener('mouseover', on_hover);
  }
};
</script>
            </section>

          </div>
        </div>
      </div>
<a href="client-side-linking.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="javascript.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cpsievert/plotly_book/edit/master/linked-views-shiny.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
